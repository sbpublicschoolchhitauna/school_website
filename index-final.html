<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S.B. Public School Chhitauna — Student Portal</title>

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">

    <div class="header">
      <div class="brand">
        <h1>S.B. PUBLIC SCHOOL CHHITAUNA</h1>
        <div class="meta">POST MEGHAULI KALA — PIN 273304 · PRINCIPAL: MR. GAJENDRA YADAV</div>
        <div class="meta">CREATED BY: UPENDRA VISHWAKARMA</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number डालकर Search करें</div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1 1 240px">
            <button class="btn" onclick="searchStudent()">Search</button>
          </div>
          <div id="result" style="margin-top:12px"></div>
        </div>

        <div class="card" style="margin-top:var(--gap)">
          <h2>Quick Portals</h2>
          <div class="small">Useful quick links</div>
          <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px">
            <a class="btn" href="#" target="_blank">Fee Portal</a>
            <a class="btn" href="#" target="_blank">Marksheet</a>
          </div>
        </div>

        <div class="card" style="margin-top:var(--gap);padding:12px;background:transparent;box-shadow:none">
          <div class="two-col">
            <div class="card">
              <h2>Fee Student Details</h2>
              <div class="small">नीचे सभी Fee Student Details (Mobile/Aadhar masked)</div>
              <div class="table-wrap" id="feeResult" style="margin-top:10px;max-height:420px;overflow:auto"></div>
            </div>

            <div class="card">
              <h2>Marksheet Details</h2>
              <div class="small">नीचे पूरी Marksheet Details सूची</div>
              <div class="table-wrap" id="msResult" style="margin-top:10px;max-height:420px;overflow:auto"></div>
            </div>
          </div>
        </div>

      </div>

      <div class="card">
        <h2>Notifications</h2>
        <div id="notifyWrap" class="notify">
          <div id="notifs" class="notify-list"></div>
        </div>
      </div>
    </div>

    <footer>© <span id="year"></span> S.B. PUBLIC SCHOOL — All Rights Reserved</footer>
  </div>

<script>
const SHEET_ID = '1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8';

function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function loadSheetGviz(sheetName){
  const url = 'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/gviz/tq?sheet=' + encodeURIComponent(sheetName) + '&tqx=out:json';
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const text = await res.text();
  const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}

/* Notifications */
async function loadNotifications(){
  try{
    const data = await loadSheetGviz('Notification');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const wrap = document.getElementById('notifs'); wrap.innerHTML='';
    rows.forEach(cells=>{
      const obj={}; cols.forEach((cl,i)=>{ obj[cl] = cells[i]? (cells[i].v!==undefined?cells[i].v:(cells[i].f||'')) : '' });
      const d = obj['Date']||obj['date']||obj['Day']||'';
      const t = obj['Notification']||obj['Text']||obj['Message']||Object.values(obj).find(v=>v);
      const node = document.createElement('div'); node.className='notify-item'; node.innerHTML = '<div class="date">'+escapeHtml(d)+'</div><div class="text">'+escapeHtml(t)+'</div>'; wrap.appendChild(node);
    });
    const orig = wrap.children.length; for(let i=0;i<orig;i++){ wrap.appendChild(wrap.children[i].cloneNode(true)); }
    let pos=0; let raf=null; function step(){ pos-=0.4; const total = wrap.scrollHeight/2; if(Math.abs(pos)>=total) pos=0; wrap.style.transform='translateY('+pos+'px)'; raf=requestAnimationFrame(step); }
    step(); const outer=document.getElementById('notifyWrap'); outer.addEventListener('mouseenter', ()=>{ if(raf) cancelAnimationFrame(raf); raf=null; }); outer.addEventListener('mouseleave', ()=>{ if(!raf) step(); });
  }catch(e){ console.error(e); document.getElementById('notifs').innerHTML = '<div class="notify-item"><div class="date">--</div><div class="text">नोटिफिकेशन लोड में त्रुटि — sheet sharing जाँचें।</div></div>'; }
}

/* Student Search */
async function searchStudent(){
  const adm = document.getElementById('admission').value.trim();
  if(!adm) return alert('Admission Number डालें');
  try{
    const data = await loadSheetGviz(\"Student's Details\");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{ const obj={}; cols.forEach((cl,i)=>{ obj[cl]=cells[i]? (cells[i].v!==undefined?cells[i].v:(cells[i].f||'')) : '' }); return obj; });
    const rec = records.find(r => String(r['Admission No.'])===adm || String(r['Adm. No.'])===adm || String(r['Admission No'])===adm || String(r['Adm No'])===adm);
    const out = document.getElementById('result'); out.style.display='block';
    if(!rec){ out.innerHTML = '<div class=\"field\"><strong>Not Found</strong><div>कोई विवरण नहीं मिला।</div></div>'; return; }
    out.innerHTML = '<div class=\"field\"><strong>Student Name</strong>'+escapeHtml(rec['Student Name']||'')+'</div>'+
                    '<div class=\"field\"><strong>Father</strong>'+escapeHtml(rec['Father Name']||'')+'</div>'+
                    '<div class=\"field\"><strong>Mother</strong>'+escapeHtml(rec['Mother Name']||'')+'</div>'+
                    '<div class=\"field\"><strong>DOB</strong>'+escapeHtml(rec['Date of Birth']||'')+'</div>'+
                    '<div class=\"field\"><strong>Class</strong>'+escapeHtml(rec['Class']||'')+'</div>'+
                    '<div class=\"field\"><strong>Address</strong>'+escapeHtml(rec['Address']||'')+'</div>';
  }catch(e){ console.error(e); alert('डेटा लोड में त्रुटि — console देखें'); }
}

/* Load all Fee and Marksheet rows (responsive table) */
function maskLast4(str){ str=String(str||''); if(str.length<=4) return str; return str.slice(0,-4).replace(/./g,'*')+str.slice(-4); }

async function loadAllFee(){
  try{
    const data = await loadSheetGviz('Fee Student Details');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    let html = '<table class=\"timetable\"><thead><tr>';
    const show=['Adm. No.','Student Name','Father Name','Mother Name','Address','Mobile No.','Aadhar No.','Date of Birth','Class'];
    show.forEach(c=> html += '<th>'+escapeHtml(c)+'</th>');
    html += '</tr></thead><tbody>';
    rows.forEach(cells=>{
      const obj={}; cols.forEach((cl,i)=>{ obj[cl]=cells[i]? (cells[i].v!==undefined?cells[i].v:(cells[i].f||'')) : '' });
      html += '<tr>';
      show.forEach(col=>{ let v = obj[col]||''; if(col==='Mobile No.'||col==='Aadhar No.') v = maskLast4(v); html += '<td>'+escapeHtml(v)+'</td>'; });
      html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('feeResult').innerHTML = html;
  }catch(e){ console.error(e); document.getElementById('feeResult').innerHTML = '<div class=\"small\">Fee data लोड में त्रुटि।</div>'; }
}

async function loadAllMarksheet(){
  try{
    const data = await loadSheetGviz('Marksheet Details');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    let html = '<table class=\"timetable\"><thead><tr>';
    const show=['Admission No.','Student Name','Father Name','Mother Name','Date of Birth','Class','Address'];
    show.forEach(c=> html += '<th>'+escapeHtml(c)+'</th>');
    html += '</tr></thead><tbody>';
    rows.forEach(cells=>{
      const obj={}; cols.forEach((cl,i)=>{ obj[cl]=cells[i]? (cells[i].v!==undefined?cells[i].v:(cells[i].f||'')) : '' });
      html += '<tr>';
      show.forEach(col=>{ let v = obj[col]||''; html += '<td>'+escapeHtml(v)+'</td>'; });
      html += '</tr>';
    });
    html += '</tbody></table>';
    document.getElementById('msResult').innerHTML = html;
  }catch(e){ console.error(e); document.getElementById('msResult').innerHTML = '<div class=\"small\">Marksheet data लोड में त्रुटि।</div>'; }
}

// init
window.addEventListener('load', ()=>{
  document.getElementById('year').innerText = new Date().getFullYear();
  loadNotifications();
  loadAllFee();
  loadAllMarksheet();
});
</script>
</body>
</html>
