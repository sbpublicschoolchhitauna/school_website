<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School ‚Äî Student Portal (Final)</title>
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Segoe UI,Roboto,sans-serif;color:#0f172a;background:linear-gradient(180deg,#eaf4ff,#f7fbff)}
.header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;text-align:center;padding:18px 12px;border-radius:0 0 14px 14px;box-shadow:0 6px 18px rgba(0,0,0,0.12);position:sticky;top:0;z-index:999}
.header h1{margin:0;font-size:clamp(20px,4.5vw,30px);font-weight:800}
.container{max-width:1100px;margin:14px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff;max-height:360px}
.table-wrap table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px solid #f1f7ff;text-align:left}
.helper-fab{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#fff;border-radius:12px;padding:12px 14px;box-shadow:0 12px 30px rgba(2,6,23,0.18);z-index:99999;cursor:pointer}
.helper-panel{position:fixed;right:18px;bottom:78px;width:320px;max-width:calc(100% - 36px);background:#fff;border-radius:12px;box-shadow:0 18px 40px rgba(2,6,23,0.18);z-index:99999;padding:12px;display:none}
.helper-response{margin-top:10px;max-height:220px;overflow:auto;border-radius:8px;padding:8px;background:#f8fbff;border:1px solid #eef6ff}
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}
.small-muted{color:#6b7280;font-size:13px}
.topper-card{padding:10px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fbff);border:1px solid #eef6ff;margin-bottom:8px}
.list-item{padding:8px;border-radius:8px;margin-bottom:8px;background:#fff;border:1px solid #f1f7ff}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.06);padding:6px 12px;border-radius:8px;margin-right:8px}
</style>
</head>
<body>
  <div class="header" role="banner">
    <h1>S.B. PUBLIC SCHOOL ‚Äî Student Portal</h1>
    <div class="small-muted">Village Chhitauna ¬∑ Principal: Mr. Gajendra Yadav ¬∑ Call: +91 6389259200</div>
    <div style="margin-top:8px" id="schoolStripOuter"><div id="schoolStrip" style="display:flex;gap:8px;flex-wrap:nowrap;overflow:hidden"></div></div>
  </div>

  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number ‡§°‡§æ‡§≤‡§ï‡§∞ Search ‡§ï‡§∞‡•á‡§Ç</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
            <button class="btn" onclick="searchStudent()">Search</button>
          </div>
          <div id="result" style="margin-top:10px"></div>
          <div style="margin-top:10px">
            <button class="btn" onclick="exportStudentsCSV()">Export updated students CSV</button>
            <div class="small" style="margin-top:6px">(‡§Ø‡§π CSV Student's Details ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ <strong>Wish</strong> column ‡§≤‡•á ‡§ï‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§ó‡§æ ‚Äî ‡§Ü‡§™ ‡§á‡§∏‡•á Google Sheets ‡§Æ‡•á‡§Ç ‡§´‡§ø‡§∞ ‡§∏‡•á upload ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç.)</div>
          </div>
        </div>

        <div class="card">
          <h2>Marksheet ‚Äî Topper Summary</h2>
          <div class="small">Sheet: <code>Marksheet Details</code> ‚Üí class-wise totals, MM, Percentage, Rank</div>
          <div id="topperSummary" style="margin-top:10px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div style="margin-top:12px" id="marksheetTable" class="table-wrap"></div>
        </div>

        <div class="card">
          <h2>Study Helpers</h2>
          <div class="small">Study Materials / Homework / Timetable / Doubts / Career ‚Äî Google Sheets ‡§∏‡•á auto-load</div>
          <div style="margin-top:8px" id="helpersContent">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Notifications</h2>
          <div id="notifyOuter" class="table-wrap" style="max-height:240px;padding:8px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>

        <div class="card">
          <h2>Topper Quick View</h2>
          <div id="topperCards">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>
      </div>
    </div>

    <div class="footer">¬© <span id="year"></span> S.B. PUBLIC SCHOOL ‚Äî All Rights Reserved</div>
  </div>

  <div class="helper-fab" id="helperFab" role="button" aria-haspopup="true" aria-expanded="false">Ask Helper</div>
  <div class="helper-panel" id="helperPanel" aria-hidden="true">
    <h3>Ask Your Helper</h3>
    <div style="display:flex;gap:8px">
      <input id="helperQuery" placeholder="Type question (e.g. formula, English help)" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eef6ff"/>
      <button class="btn" onclick="helperAsk()">Ask</button>
    </div>
    <div class="helper-response" id="helperResp">You can ask simple subject questions or search FAQs.</div>
  </div>

<script>
/* ========== CONFIG ========== */
/* User-provided Google Sheet ID */
const SHEET_ID = "1nlnyj4NhLD3KGKiuc9qERSoaBl8ml_TC_B8Z2V3V7OY";

/* small debounce helper */
function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

/* safe gviz fetch with timeouts & useful error messages */
async function loadSheetGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), 9000);
  try{
    const res = await fetch(url, {signal: controller.signal, cache: "no-store"});
    clearTimeout(id);
    if(!res.ok) throw new Error('Sheet fetch failed: ' + res.status);
    const text = await res.text();
    const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
    return JSON.parse(jsonText);
  }catch(e){
    clearTimeout(id);
    console.error(`Error loading sheet "${sheetName}":`, e);
    throw e;
  }
}

function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ===== STUDENTS: load and compute Wish for birthdays ===== */
let STUDENTS_ROWS = [];
async function loadStudents(){
  try{
    const data = await loadSheetGviz("Student's Details");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]||('col'+i)] = v;
      }
      return obj;
    });

    const today = new Date();
    const tDay = today.getDate();
    const tMon = today.getMonth() + 1;
    records.forEach(r=>{
      r.Wish = "";
      const dob = r['Date of Birth'] || r['DOB'] || r['Birthdate'] || r['Birth Date'] || '';
      if(dob){
        // try multiple parsing attempts
        let parsed = null;
        // if numeric epoch
        if(String(dob).match(/^\d+$/)) parsed = new Date(Number(dob));
        if(!parsed){
          // try Date.parse
          const p = Date.parse(String(dob));
          if(!isNaN(p)) parsed = new Date(p);
        }
        if(!parsed){
          const m = String(dob).match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
          if(m) parsed = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        }
        if(parsed && parsed.getDate() === tDay && (parsed.getMonth()+1) === tMon){
          r.Wish = "üéâ Happy Birthday! ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Å";
        }
      }
    });

    STUDENTS_ROWS = records;
    return records;
  }catch(e){
    console.error("loadStudents error", e);
    STUDENTS_ROWS = [];
    return [];
  }
}

/* search student */
function searchStudent(){
  const adm = document.getElementById('admission').value.trim();
  if(!adm) return alert('Admission Number ‡§°‡§æ‡§≤‡•á‡§Ç');
  const rec = STUDENTS_ROWS.find(r => {
    return (String(r['Admission No.']||r['Adm No']||r['Admission Number']||'')).trim() === adm.trim();
  });
  const out = document.getElementById('result');
  if(!rec) { out.innerHTML = '<div style="padding:12px;background:#fff;border-radius:8px;border:1px solid #f1f7ff">No details found for this Admission Number.</div>'; return; }
  let html = '<div style="padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ff">';
  html += `<div><strong>Student Name:</strong> ${escapeHtml(rec['Student Name']||rec['Name']||'')}</div>`;
  html += `<div><strong>Class:</strong> ${escapeHtml(rec['Class']||'')}</div>`;
  html += `<div><strong>Father:</strong> ${escapeHtml(rec['Father Name']||'')}</div>`;
  html += `<div><strong>Mobile:</strong> ${escapeHtml(rec['Mobile']||'')}</div>`;
  if(rec.Wish) html += `<div style="margin-top:8px;color:green;font-weight:700">${escapeHtml(rec.Wish)}</div>`;
  html += '</div>';
  out.innerHTML = html;
}

/* export updated students CSV */
function exportStudentsCSV(){
  if(!STUDENTS_ROWS || STUDENTS_ROWS.length===0){ alert('Students data ‡§®‡§π‡•Ä‡§Ç loaded ‡§π‡•à‡•§'); return; }
  const cols = Object.keys(STUDENTS_ROWS[0]);
  const lines = [cols.join(',')];
  STUDENTS_ROWS.forEach(r=>{
    const row = cols.map(c=> {
      const v = r[c]===undefined ? '' : String(r[c]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(',');
    lines.push(row);
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'students_with_wish.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===== MARKSHEET processing: aggregate, MM, Percentage, Rank ===== */
let MARKS_RAW = [];
async function loadMarksheetAndCompute(){
  try{
    const data = await loadSheetGviz('Marksheet Details');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]||('col'+i)] = v;
      }
      return obj;
    });

    // determine if sheet already has totals
    const hasTotal = records.length>0 && (records[0]['Total Marks'] !== undefined || records[0]['Total'] !== undefined);
    let agg = [];
    if(hasTotal){
      agg = records.map(r=>({
        admission: r['Admission No.']||r['Admission']||r['Adm No']||'',
        name: r['Student Name']||r['Name']||'',
        cls: r['Class']||'',
        total: Number(r['Total Marks']||r['Total']||0)
      }));
    } else {
      // assume subject-level; sum Marks per admission+name+class
      const map = {};
      records.forEach(r=>{
        const key = (r['Admission No.']||r['Admission']||r['Adm No']||'') + '||' + (r['Student Name']||r['Name']||'') + '||' + (r['Class']||'');
        const marks = Number(r['Marks']||r['Mark']||r['Obtained']||0);
        if(!map[key]) map[key] = {admission:(r['Admission No.']||r['Admission']||r['Adm No']||''), name:(r['Student Name']||r['Name']||''), cls:(r['Class']||''), total:0};
        map[key].total += marks;
      });
      agg = Object.values(map);
    }

    // group by class, compute MM (maximum total), percentage, dense rank
    const byClass = {};
    agg.forEach(it=>{
      const cls = String(it.cls||'').trim() || 'Unspecified';
      if(!byClass[cls]) byClass[cls] = [];
      byClass[cls].push(it);
    });

    const final = [];
    Object.keys(byClass).forEach(cls=>{
      const arr = byClass[cls];
      let mm = 0;
      arr.forEach(a=>{ if(a.total > mm) mm = a.total; });
      // compute percent and later rank
      arr.forEach(a=>{ a.MM = mm; a.Max = mm; a.Percentage = mm>0 ? ((a.total / mm) * 100).toFixed(2) : '0.00'; });
      // dense rank
      const sorted = arr.slice().sort((a,b)=> b.total - a.total);
      let last = null, rank = 0;
      sorted.forEach(s=>{
        if(last === null || s.total !== last){ rank += 1; last = s.total; }
        s.Rank = rank;
      });
      // push results
      sorted.forEach(s=> final.push({cls:cls, admission:s.admission, name:s.name, total:s.total, MM:s.MM, Max:s.Max, Percentage:s.Percentage, Rank:s.Rank}));
    });

    MARKS_RAW = final;
    renderMarksheet(final);
    renderTopperSummary(final);
    return final;
  }catch(e){
    console.error('marksheet load error', e);
    document.getElementById('marksheetTable').innerHTML = '<div style="padding:12px;color:#c33">Marksheet ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü ‚Äî sharing & sheet-name ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>';
    document.getElementById('topperSummary').innerHTML = '';
    MARKS_RAW = [];
    return [];
  }
}

function renderMarksheet(list){
  if(!list || list.length===0){ document.getElementById('marksheetTable').innerHTML = '<div style="padding:12px">No marksheet data.</div>'; return; }
  const cols = ['Class','Admission No.','Student Name','Total Marks','MM','Max','Percentage','Rank'];
  let html = '<table><thead><tr>';
  cols.forEach(c=> html += `<th>${escapeHtml(c)}</th>`);
  html += '</tr></thead><tbody>';
  list.forEach(r=>{
    html += '<tr>';
    html += `<td>${escapeHtml(r.cls)}</td>`;
    html += `<td>${escapeHtml(r.admission)}</td>`;
    html += `<td>${escapeHtml(r.name)}</td>`;
    html += `<td>${escapeHtml(String(r.total))}</td>`;
    html += `<td>${escapeHtml(String(r.MM))}</td>`;
    html += `<td>${escapeHtml(String(r.Max))}</td>`;
    html += `<td>${escapeHtml(String(r.Percentage))}%</td>`;
    html += `<td>${escapeHtml(String(r.Rank))}</td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('marksheetTable').innerHTML = html;
}

function renderTopperSummary(list){
  if(!list || list.length===0){ document.getElementById('topperSummary').innerHTML = '<div>No data</div>'; return; }
  const perClass = {};
  list.forEach(r=>{
    if(!perClass[r.cls]) perClass[r.cls] = [];
    perClass[r.cls].push(r);
  });
  let html = '';
  const cards = [];
  Object.keys(perClass).forEach(cls=>{
    const arr = perClass[cls].filter(x=> x.Rank === 1);
    if(arr.length === 0){
      // fallback: top by total
      const top = perClass[cls].slice().sort((a,b)=> b.total - a.total)[0];
      if(top) arr.push(top);
    }
    arr.forEach(t=>{
      html += `<div class="topper-card"><strong>Class ${escapeHtml(cls)}</strong><div>${escapeHtml(t.name)} ‚Äî ${escapeHtml(String(t.total))} marks ‚Äî ${escapeHtml(String(t.Percentage))}%</div></div>`;
      cards.push(t);
    });
  });
  document.getElementById('topperSummary').innerHTML = html;
  const right = document.getElementById('topperCards');
  if(right){
    right.innerHTML = cards.map(tc=>`<div class="topper-card"><strong>Class ${escapeHtml(tc.cls)}</strong><div>${escapeHtml(tc.name)}</div><div class="small">Marks: ${escapeHtml(String(tc.total))} ‚Ä¢ ${escapeHtml(tc.Percentage)}%</div></div>`).join('');
  }
}

/* ===== HELPERS: load Study Materials, Homework, Timetable, Doubts, Career, Notification ===== */
async function loadHelpersAll(){
  try{
    const [sm, hw, tt, db, cg, nf] = await Promise.allSettled([
      loadSheetGviz('Study Materials'),
      loadSheetGviz('Homework'),
      loadSheetGviz('Timetable'),
      loadSheetGviz('Doubts'),
      loadSheetGviz('Career Guidance'),
      loadSheetGviz('Notification')
    ]);
    // Study Materials
    let smHtml = '<div>';
    if(sm.status === 'fulfilled'){
      const rows = (sm.value.table.rows||[]).map(r=> r.c || []);
      rows.forEach(r=>{
        const title = (r[0] && r[0].v) || '';
        const cls = (r[1] && r[1].v) || '';
        const link = (r[2] && r[2].v) || '';
        smHtml += `<div class="list-item"><strong>${escapeHtml(title)}</strong><div class="small">Class: ${escapeHtml(cls)}</div>`;
        if(link) smHtml += `<div style="margin-top:6px"><a class="btn" href="${escapeHtml(link)}" target="_blank">Open</a></div>`;
        smHtml += '</div>';
      });
    } else smHtml += '<div class="small">Study Materials ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§</div>';
    smHtml += '</div>';

    // Homework
    let hwHtml = '<div>';
    if(hw.status === 'fulfilled'){
      const rows = (hw.value.table.rows||[]).map(r=> r.c || []);
      rows.forEach(r=>{ const date = (r[0]&&r[0].v)||''; const cls=(r[1]&&r[1].v)||''; const task=(r[2]&&r[2].v)||''; hwHtml += `<div class="list-item"><strong>${escapeHtml(String(date))}</strong> ‚Äî ${escapeHtml(String(task))}<div class="small">Class: ${escapeHtml(String(cls))}</div></div>`; });
    } else hwHtml += '<div class="small">Homework ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§</div>';
    hwHtml += '</div>';

    // Timetable
    let ttHtml = '<div style="overflow:auto">';
    if(tt.status === 'fulfilled'){
      const cols = (tt.value.table.cols||[]).map(c=>c.label||c.id||'');
      const rows = (tt.value.table.rows||[]).map(r=> r.c || []);
      ttHtml += '<table><thead><tr>';
      cols.forEach(c=> ttHtml += `<th>${escapeHtml(c)}</th>`);
      ttHtml += '</tr></thead><tbody>';
      rows.forEach(r=>{ ttHtml += '<tr>'; for(let i=0;i<cols.length;i++){ const v = (r[i] && r[i].v) || ''; ttHtml += `<td>${escapeHtml(String(v))}</td>` } ttHtml += '</tr>'; });
      ttHtml += '</tbody></table>';
    } else ttHtml += '<div class="small">Timetable ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>';
    ttHtml += '</div>';

    // Doubts
    let dbHtml = '<div>';
    if(db.status === 'fulfilled'){
      const rows = (db.value.table.rows||[]).map(r=> r.c || []);
      rows.forEach(r=>{ const q=(r[0]&&r[0].v)||''; const a=(r[1]&&r[1].v)||''; dbHtml += `<div class="list-item"><strong>Q: ${escapeHtml(String(q))}</strong><div>A: ${escapeHtml(String(a))}</div></div>`; });
    } else dbHtml += '<div class="small">Doubts/FAQ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§</div>';
    dbHtml += '</div>';

    // Career Guidance
    let cgHtml = '<div>';
    if(cg.status === 'fulfilled'){
      const rows = (cg.value.table.rows||[]).map(r=> r.c || []);
      rows.forEach(r=>{ const t=(r[0]&&r[0].v)||''; const adv=(r[1]&&r[1].v)||''; cgHtml += `<div class="list-item"><strong>${escapeHtml(String(t))}</strong><div>${escapeHtml(String(adv))}</div></div>`; });
    } else cgHtml += '<div class="small">Career Guidance ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>';
    cgHtml += '</div>';

    // Notifications
    let nfHtml = '<div>';
    if(nf.status === 'fulfilled'){
      const rows = (nf.value.table.rows||[]).map(r=> r.c || []);
      rows.forEach(r=>{ const d=(r[0]&&r[0].v)||''; const t=(r[1]&&r[1].v)||''; nfHtml += `<div class="list-item"><strong>${escapeHtml(String(d))}</strong><div>${escapeHtml(String(t))}</div></div>`; });
    } else nfHtml += '<div class="small">Notifications ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡•§</div>';
    nfHtml += '</div>';

    document.getElementById('helpersContent').innerHTML = `<h4>Study Materials</h4>${smHtml}<h4>Homework</h4>${hwHtml}<h4>Timetable</h4>${ttHtml}<h4>Doubts</h4>${dbHtml}<h4>Career</h4>${cgHtml}`;
    document.getElementById('notifyOuter').innerHTML = nfHtml;

    // build header chips from notifications
    try{
      const chipWrap = document.getElementById('schoolStrip');
      chipWrap.innerHTML = '';
      if(nf.status === 'fulfilled'){
        const rows = (nf.value.table.rows||[]).map(r=> r.c || []);
        rows.slice(0,10).forEach(r=>{ const d=(r[0]&&r[0].v)||''; const t=(r[1]&&r[1].v)||''; const span = document.createElement('div'); span.className='school-chip'; span.title = `${d} - ${t}`; span.innerText = `${d} - ${t}`; chipWrap.appendChild(span); });
      }
    }catch(e){ console.warn('header chips build failed', e); }

  }catch(e){
    console.error('loadHelpersAll error', e);
  }
}

/* small FAQ-search helper for floating panel */
async function helperAsk(){
  const q = document.getElementById('helperQuery').value.trim();
  const resp = document.getElementById('helperResp');
  if(!q){ resp.innerHTML = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç‡•§ (‡§â‡§¶‡§æ: "area of circle" ‡§Ø‡§æ "past simple rule")'; return; }
  resp.innerHTML = 'Searching FAQs...';
  try{
    const data = await loadSheetGviz('Doubts');
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const found = [];
    rows.forEach(r=>{
      const ques = (r[0] && r[0].v) || '';
      const ans = (r[1] && r[1].v) || '';
      if(String(ques).toLowerCase().includes(q.toLowerCase()) || String(ans).toLowerCase().includes(q.toLowerCase())){
        found.push({q:ques, a:ans});
      }
    });
    if(found.length){ resp.innerHTML = found.slice(0,5).map(f=>`<div style="margin-bottom:8px"><strong>Q: ${escapeHtml(f.q)}</strong><div>A: ${escapeHtml(f.a)}</div></div>`).join(''); return; }
  }catch(e){ console.warn('helper search failed', e); }
  const canned = {'area of circle':'Area = œÄ √ó r √ó r (œÄ ‚âà 3.14).', 'past simple':'Regular verbs add -ed (e.g., walked). Irregular verbs change (e.g., went).'};
  for(const k in canned) if(q.toLowerCase().includes(k)){ document.getElementById('helperResp').innerHTML = canned[k]; return; }
  resp.innerHTML = '‡§Æ‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç ‚Äî FAQ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ Teacher ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç ‡§Ø‡§æ Doubts sheet ‡§Æ‡•á‡§Ç ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§°‡§æ‡§≤‡•á‡§Ç‡•§';
}

/* helper panel toggle */
const helperFab = document.getElementById('helperFab');
const helperPanel = document.getElementById('helperPanel');
helperFab.addEventListener('click', ()=>{ const open = helperPanel.style.display==='block'; helperPanel.style.display = open ? 'none' : 'block'; helperFab.setAttribute('aria-expanded', String(!open)); helperPanel.setAttribute('aria-hidden', String(open)); });

/* init sequence */
document.getElementById('year').innerText = new Date().getFullYear();
(async function init(){
  await loadStudents();
  await loadMarksheetAndCompute();
  await loadHelpersAll();
})();

/* safe global handlers to avoid exceptions in older browsers */
window.addEventListener('error', function(e){ console.warn('Window error:', e.message); });

</script>
</body>
</html>
