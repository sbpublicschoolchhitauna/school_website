<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S.B. Public School Chhitauna — Student Portal</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>S.B. PUBLIC SCHOOL CHHITAUNA</h1>
      <div class="mid">POST MEGHAULI KALA — PIN 273304</div>
      <div class="last">PRINCIPAL : MR. GAJENDRA YADAV — CALL : +916389259200</div>
      <div class="last">CREATED BY : UPENDRA VISHWAKARMA</div>
    </div>
    <div class="grid">
      <div>
        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number डालकर Search करें</div>
          <input id="admission" placeholder="Enter Admission Number">
          <button class="btn" onclick="searchStudent()">Search</button>
          <div id="result"></div>
        </div>
        <div class="card" style="margin-top:14px;">
          <h2>Quick Portals</h2>
          <div class="portals">
            <a href="#" target="_blank">Fee Portal</a>
            <a href="#" target="_blank">Marksheet</a>
          </div>
        </div>
        <div class="card" style="margin-top:14px; padding:0; background:none; box-shadow:none;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px;">
            <div class="card">
              <h2>Fee Student Details</h2>
              <div class="small">नीचे सभी Fee Student Details दिखाई दे रहे हैं (Mobile/Aadhar masked)</div>
              <div id="feeResult" style="margin-top:12px; max-height:420px; overflow:auto;"></div>
            </div>
            <div class="card">
              <h2>Marksheet Details</h2>
              <div class="small">नीचे पूरी Marksheet Details सूची दिखाई देगी</div>
              <div id="msResult" style="margin-top:12px; max-height:420px; overflow:auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>Notifications</h2>
        <div id="notifyWrap" class="notify">
          <div id="notifs" class="notify-list"></div>
        </div>
      </div>
    </div>
    <footer>© <span id="year"></span> S.B. PUBLIC SCHOOL — All Rights Reserved</footer>
  </div>
<script>
const SHEET_ID = '1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8';
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
async function loadSheetGviz(sheetName){ const url='https://docs.google.com/spreadsheets/d/'+SHEET_ID+'/gviz/tq?sheet='+encodeURIComponent(sheetName)+'&tqx=out:json'; const res=await fetch(url); const text=await res.text(); const jsonText=text.replace(/^[^{]*/,'').replace(/\);\s*$/,''); return JSON.parse(jsonText); }
async function loadAllFee(){ try{ const data=await loadSheetGviz('Fee Student Details'); const cols=(data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim()); const rows=(data.table.rows||[]).map(r=> r.c || []); let html='<table class="timetable"><thead><tr>'; const show=['Adm. No.','Student Name','Father Name','Mother Name','Address','Mobile No.','Aadhar No.','Date of Birth','Class']; show.forEach(c=> html+='<th>'+escapeHtml(c)+'</th>'); html+='</tr></thead><tbody>'; function maskLast4(str){str=String(str||''); if(str.length<=4) return str; return str.slice(0,-4).replace(/./g,'*')+str.slice(-4);} rows.forEach(c=>{ const obj={}; cols.forEach((cl,i)=>{ obj[cl]=c[i]? (c[i].v!==undefined?c[i].v:(c[i].f||'')) : ''; }); html+='<tr>'; show.forEach(col=>{ let v=obj[col]||''; if(col=='Mobile No.'||col=='Aadhar No.') v=maskLast4(v); html+='<td>'+escapeHtml(v)+'</td>'; }); html+='</tr>'; }); html+='</tbody></table>'; document.getElementById('feeResult').innerHTML=html;}catch(e){ console.error(e); document.getElementById('feeResult').innerHTML='<div class="small">Fee data लोड में त्रुटि।</div>'; } }
async function loadAllMarksheet(){ try{ const data=await loadSheetGviz('Marksheet Details'); const cols=(data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim()); const rows=(data.table.rows||[]).map(r=> r.c || []); let html='<table class="timetable">'; const show=['Admission No.','Student Name','Father Name','Mother Name','Date of Birth','Class','Address']; html+='<thead><tr>'; show.forEach(c=> html+='<th>'+escapeHtml(c)+'</th>'); html+='</tr></thead><tbody>'; rows.forEach(c=>{ const obj={}; cols.forEach((cl,i)=>{ obj[cl]=c[i]? (c[i].v!==undefined?c[i].v:(c[i].f||'')) : ''; }); html+='<tr>'; show.forEach(col=>{ let v=obj[col]||''; html+='<td>'+escapeHtml(v)+'</td>'; }); html+='</tr>'; }); html+='</tbody></table>'; document.getElementById('msResult').innerHTML=html;}catch(e){ console.error(e); document.getElementById('msResult').innerHTML='<div class="small">Marksheet data लोड में त्रुटि।</div>'; } }
async function loadNotificationsRobust(){ try{ const data=await loadSheetGviz('Notification'); const cols=(data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim().replace(/\u200B/g,'')); const rows=(data.table.rows||[]).map(r=> r.c || []); const wrap=document.getElementById('notifs'); wrap.innerHTML=''; rows.forEach(cells=>{ const obj={}; cols.forEach((cl,i)=>{ obj[cl]=cells[i]? (cells[i].v!==undefined?cells[i].v:(cells[i].f||'')) : ''; }); const d=obj['Date']||obj['date']||obj['Day']||''; const t=obj['Notification']||obj['Text']||obj['Message']||Object.values(obj).slice(0,1).join('')||''; const node=document.createElement('div'); node.className='notify-item'; node.innerHTML='<div class="date">'+escapeHtml(d)+'</div><div class="text">'+escapeHtml(t)+'</div>'; wrap.appendChild(node); }); const orig=wrap.children.length; for(let i=0;i<orig;i++){ wrap.appendChild(wrap.children[i].cloneNode(true)); } let pos=0; function step(){ pos-=0.3; const total=wrap.scrollHeight/2; if(Math.abs(pos)>=total) pos=0; wrap.style.transform='translateY('+pos+'px)'; requestAnimationFrame(step);} step(); }catch(e){ console.error(e); const wrap=document.getElementById('notifs'); wrap.innerHTML='<div class="notify-item"><div class="date">--</div><div class="text">नोटिफिकेशन लोड नहीं हुए — sheet की sharing settings और sheet name जाँचें।</div></div>'; } }
window.addEventListener('load', function(){ document.getElementById('year').innerText=new Date().getFullYear(); loadNotificationsRobust(); loadAllFee(); loadAllMarksheet(); });
</script>
</body>
</html>
