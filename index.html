<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School — Final Theme</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg: #fbfdff;
  --surface: #ffffff;
  --text: #0f1724;
  --muted: #556070;
  --accent1: #0ea5a4; /* teal */
  --accent2: #4f7cff; /* soft blue */
  --glass: rgba(15,23,36,0.03);
  --card-shadow: rgba(16,24,40,0.06);
  --notif-speed: 0.35;
  --header-speed: 0.45;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:14px auto;padding:16px}

/* header */
.header{
  padding:20px;border-radius:12px;position:relative;background:linear-gradient(90deg,var(--accent1),var(--accent2));
  color: #fff; overflow:hidden;
  box-shadow: 0 8px 20px var(--card-shadow);
}
.header-inner{text-align:center}
.header h1{margin:0;font-size:clamp(20px,4.2vw,30px);font-weight:800;color:white}
.header p{margin:6px 0;color:rgba(255,255,255,0.95)}
.strip-wrap{margin-top:12px;overflow:hidden;border-radius:10px;padding:8px;background:rgba(255,255,255,0.08)}
.strip{display:flex;gap:12px;white-space:nowrap;will-change:transform;align-items:center}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.92);color:var(--text);padding:6px 12px;border-radius:8px;box-shadow:0 2px 6px rgba(16,24,40,0.04)}

/* layout */
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:16px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--surface);border:1px solid rgba(15,23,36,0.04);padding:14px;border-radius:12px;box-shadow:0 6px 18px var(--card-shadow)}
.btn{padding:8px 12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;cursor:pointer;font-weight:700}
.tabbar{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(15,23,36,0.04);color:var(--text);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 8px 20px rgba(11,84,120,0.08);color:#fff;transform:translateY(-2px)}

/* tables */
.table-wrap{overflow:auto;border-radius:10px;border:1px solid rgba(15,23,36,0.03);padding:6px;background:var(--surface);max-height:420px}
table{width:100%;border-collapse:collapse;min-width:720px}
th,td{padding:10px 12px;text-align:left;border-bottom:1px solid rgba(15,23,36,0.04);color:var(--text)}
thead th{position:sticky;top:0;background:linear-gradient(180deg,rgba(255,255,255,0.98),transparent);font-weight:700;cursor:pointer}
thead th.sort-asc:after{content:" ▲";font-size:12px}
thead th.sort-desc:after{content:" ▼";font-size:12px}
tbody tr:hover{background:rgba(11,84,120,0.03);transform:translateY(-1px)}

/* pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
.page-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(15,23,36,0.04);background:transparent;color:var(--text);cursor:pointer}

/* notifications */
.notify-wrap{height:220px;overflow:hidden;border-radius:10px}
.notify-list{position:relative;will-change:transform}
.notify-item{padding:10px;border-bottom:1px solid rgba(15,23,36,0.04);background:linear-gradient(90deg,rgba(255,255,255,0.98),transparent)}
.notify-item .date{font-weight:700;color:var(--accent2)}
.notify-item .text{margin-top:6px;color:var(--text)}

/* footer */
.footer{ text-align:center;margin-top:12px;color:var(--muted);font-size:13px}
</style>
</head>
<body>

<div class="container">

  <header class="header" role="banner" aria-label="School header">
    <div class="header-inner">
      <h1>S.B. PUBLIC SCHOOL</h1>
      <p>Village Chhitauna · Post Meghauli Kala · Pin Code 273304</p>
      <p style="margin-top:6px;font-size:13px">Principal — Mr. Gajendra Yadav Sir · Call: +91 6389259200 · Created By — Upendra Vishwakarma</p>
    </div>

    <div class="strip-wrap" style="margin-top:12px">
      <div id="schoolStrip" class="strip" aria-live="polite"></div>
    </div>
  </header>

  <main class="grid" style="margin-top:18px">
    <div>
      <!-- Quick Portals placed above Student Records -->
      <section class="card">
        <h3 style="margin-top:0">Quick Portals</h3>
        <div style="display:flex;flex-direction:row;gap:10px;margin-top:8px;flex-wrap:wrap">
          <a class="btn" id="feePortal" href="https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec" target="_blank" rel="noopener">Fee Portal</a>
          <a class="btn" id="marksPortal" href="https://script.google.com/macros/s/AKfycbzmAK3rf7ah-4BDi5BEcZeu859kPWAthpPFgsMiCbM2Gp-Do0yuS7QpzucWRssZMwqLtA/exec" target="_blank" rel="noopener">Marksheet Portal</a>
        </div>
      </section>

      <section class="card" style="margin-top:12px">
        <h2 style="margin-bottom:8px">Student Details Lookup</h2>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="admission" placeholder="Admission Number" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);background:transparent;color:var(--text)">
          <button class="btn" onclick="searchStudent()">Search</button>
        </div>
        <div id="result"></div>
      </section>

      <section class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h2 style="margin:0">Student Records</h2>
          <div style="display:flex;gap:8px">
            <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee</button>
            <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet</button>
          </div>
        </div>

        <div id="feeContainer" class="table-wrap">लोड हो रहा है...</div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div class="small">Rows per page:
            <select id="feePageSize">
              <option>10</option><option>25</option><option>50</option>
            </select>
          </div>
          <div id="feePagination" class="pagination"></div>
        </div>

        <div style="margin-top:12px;display:none">
          <div id="marksContainer" class="table-wrap">लोड हो रहा है...</div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div class="small">Rows per page:
              <select id="marksPageSize">
                <option>10</option><option>25</option><option>50</option>
              </select>
            </div>
            <div id="marksPagination" class="pagination"></div>
          </div>
        </div>

      </section>
    </div>

    <aside>
      <section class="card">
        <h3 style="margin-top:0">Notifications</h3>
        <div id="notifyOuter" class="notify-wrap">
          <div id="notifs" class="notify-list"></div>
        </div>
      </section>

    </aside>
  </main>

  <footer class="footer">© <span id="year"></span> S.B. PUBLIC SCHOOL — All Rights Reserved</footer>
</div>

<script>
const SHEET_ID = "1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8";
const NOTIF_SPEED = 0.35;
const HEADER_SPEED = 0.45;

function $(id){ return document.getElementById(id) }
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }
async function loadSheetGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const text = await res.text();
  const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}
function maskLast4(v){ if(v==null) return ''; const s=String(v).replace(/\D/g,''); if(s.length<=4) return '****'+s; return '****'+s.slice(-4) }
function isMobileHeader(h){ return /mobile|phone|contact|mob/i.test(h) }
function isAadharHeader(h){ return /aadhar|aadhaar|uid/i.test(h) }

/* render table (simple paginated renderer reused from earlier) */
const tableState = { fee:{rows:[],cols:[],sortCol:null,sortDir:1,page:1,pageSize:10}, marks:{rows:[],cols:[],sortCol:null,sortDir:1,page:1,pageSize:10} };

function renderPaginatedTable(key, containerId, paginationId){
  const state = tableState[key];
  const cols = state.cols;
  const rows = state.rows.slice();
  if(state.sortCol !== null){
    rows.sort((a,b)=>{
      const A = (a[state.sortCol] && a[state.sortCol].v !== undefined) ? String(a[state.sortCol].v) : (a[state.sortCol] && a[state.sortCol].f !== undefined ? String(a[state.sortCol].f) : '');
      const B = (b[state.sortCol] && b[state.sortCol].v !== undefined) ? String(b[state.sortCol].v) : (b[state.sortCol] && b[state.sortCol].f !== undefined ? String(b[state.sortCol].f) : '');
      if(!isNaN(Number(A)) && !isNaN(Number(B))) return (Number(A)-Number(B))*state.sortDir;
      return A.localeCompare(B)*state.sortDir;
    });
  }
  const pageSize = state.pageSize;
  const totalPages = Math.max(1, Math.ceil(rows.length/pageSize));
  state.page = Math.max(1, Math.min(state.page, totalPages));
  const start = (state.page-1)*pageSize;
  const pageRows = rows.slice(start, start+pageSize);

  const wrap = $(containerId);
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach((h, idx)=>{
    const th = document.createElement('th');
    th.innerText = h||'';
    if(state.sortCol === idx) th.classList.add(state.sortDir===1 ? 'sort-asc' : 'sort-desc');
    th.addEventListener('click', ()=>{
      if(state.sortCol === idx) state.sortDir = -state.sortDir;
      else { state.sortCol = idx; state.sortDir = 1; }
      renderPaginatedTable(key, containerId, paginationId);
    });
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  pageRows.forEach(r=>{
    const tr = document.createElement('tr');
    for(let i=0;i<cols.length;i++){
      const cell = r[i];
      let v = '';
      if(cell){
        if(cell.v !== undefined) v = cell.v;
        else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
      }
      const header = cols[i]||'';
      if(isMobileHeader(header)) v = maskLast4(v);
      if(isAadharHeader(header)) v = maskLast4(v);
      const td = document.createElement('td');
      td.innerText = v;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML = '';
  wrap.appendChild(table);

  // pagination controls
  const pagWrap = $(paginationId);
  pagWrap.innerHTML = '';
  const prev = document.createElement('button'); prev.className='page-btn'; prev.innerText='Prev'; prev.disabled = state.page<=1;
  prev.addEventListener('click', ()=>{ state.page = Math.max(1, state.page-1); renderPaginatedTable(key, containerId, paginationId); });
  pagWrap.appendChild(prev);
  const info = document.createElement('div'); info.className='small'; info.style.margin='0 8px'; info.innerText = `Page ${state.page} of ${totalPages}`;
  pagWrap.appendChild(info);
  const next = document.createElement('button'); next.className='page-btn'; next.innerText='Next'; next.disabled = state.page>=totalPages;
  next.addEventListener('click', ()=>{ state.page = Math.min(totalPages, state.page+1); renderPaginatedTable(key, containerId, paginationId); });
  pagWrap.appendChild(next);
}

/* load data */
async function loadAndRenderTables(){
  try{
    const feeJson = await loadSheetGviz('Fee Student Details');
    tableState.fee.cols = (feeJson.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    tableState.fee.rows = (feeJson.table.rows||[]).map(r=> r.c || []);
    tableState.fee.pageSize = Number($('feePageSize').value);
    renderPaginatedTable('fee','feeContainer','feePagination');
  }catch(e){ console.error(e); $('feeContainer').innerHTML='<div style="padding:12px;color:var(--muted)">Fee लोड नहीं हुए</div>' }

  try{
    const marksJson = await loadSheetGviz('Marksheet Details');
    tableState.marks.cols = (marksJson.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    tableState.marks.rows = (marksJson.table.rows||[]).map(r=> r.c || []);
    tableState.marks.pageSize = Number($('marksPageSize')?.value || 10);
    renderPaginatedTable('marks','marksContainer','marksPagination');
  }catch(e){ console.error(e); $('marksContainer').innerHTML='<div style="padding:12px;color:var(--muted)">Marksheet लोड नहीं हुए</div>' }
}

/* notifications vertical scroll */
let notifRAF=null, notifPos=0;
function startNotifScroll(){ const wrap=$('notifs'); if(!wrap) return; cancelAnimationFrame(notifRAF); const speed = Number(getComputedStyle(document.documentElement).getPropertyValue('--notif-speed'))||0.35; function step(){ notifPos -= speed; const half = wrap.scrollHeight/2||0; if(Math.abs(notifPos)>=half) notifPos=0; wrap.style.transform = `translateY(${notifPos}px)`; notifRAF = requestAnimationFrame(step) } step() }
function stopNotifScroll(){ if(notifRAF) cancelAnimationFrame(notifRAF); notifRAF=null }

async function loadNotifications(){
  try{
    const data = await loadSheetGviz('Notification');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k))||cols[1]||cols[0]||'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k))||cols[0]||'Date';
    const wrap = $('notifs'); wrap.innerHTML = '';
    rows.forEach(cells=>{ const obj={}; for(let i=0;i<cols.length;i++){ const cell=cells[i]; let v=''; if(cell){ if(cell.v!==undefined) v=cell.v; else if(cell.f!==undefined) v=String(cell.f).replace(/<[^>]*>/g,'').trim() } obj[cols[i]] = v } const d = obj[dateKey]||''; const t = obj[textKey]||''; const node = document.createElement('div'); node.className = 'notify-item'; node.innerHTML = `<div class="date">${escapeHtml(d)}</div><div class="text">${escapeHtml(t)}</div>`; wrap.appendChild(node) });
    const orig = wrap.children.length; for(let i=0;i<orig;i++){ wrap.appendChild(wrap.children[i].cloneNode(true)) }
    startNotifScroll(); const outer = $('notifyOuter'); outer.addEventListener('mouseenter', stopNotifScroll); outer.addEventListener('mouseleave', startNotifScroll);
  }catch(e){ console.error(e); $('notifs').innerHTML = '<div style="padding:12px;color:var(--muted)">Notification लोड नहीं हुए</div>' }
}

/* header strip from notifications */
let headerRAF=null, headerPos=0;
function startHeaderScroll(){ const strip=$('schoolStrip'); if(!strip) return; cancelAnimationFrame(headerRAF); const speed = Number(getComputedStyle(document.documentElement).getPropertyValue('--header-speed'))||0.45; function step(){ headerPos -= speed; const half = strip.scrollWidth/2||0; if(Math.abs(headerPos)>=half) headerPos=0; strip.style.transform = `translateX(${headerPos}px)`; headerRAF = requestAnimationFrame(step) } step() }
function stopHeaderScroll(){ if(headerRAF) cancelAnimationFrame(headerRAF); headerRAF=null }

async function buildStripFromNotifications(){
  try{
    const data = await loadSheetGviz('Notification');
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k))||cols[1]||cols[0]||'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k))||cols[0]||'Date';
    const strip = $('schoolStrip'); strip.innerHTML = ''; const items = [];
    rows.forEach(cells=>{ const obj={}; for(let i=0;i<cols.length;i++){ const cell=cells[i]; let v=''; if(cell){ if(cell.v!==undefined) v=cell.v; else if(cell.f!==undefined) v=String(cell.f).replace(/<[^>]*>/g,'').trim() } obj[cols[i]] = v } const t = obj[textKey]||''; const d = obj[dateKey]||''; if(t||d) items.push({date:d,text:t}) });
    if(items.length===0){ const sp=document.createElement('div'); sp.className='school-chip'; sp.innerText='No notifications'; strip.appendChild(sp); return }
    function chip(it){ const txt=(it.date?it.date+' - ':'')+it.text; const short = txt.length>100?txt.slice(0,97)+'...':txt; const d=document.createElement('div'); d.className='school-chip'; d.title=txt; d.innerText=short; return d }
    items.forEach(it=> strip.appendChild(chip(it))); items.forEach(it=> strip.appendChild(chip(it))); startHeaderScroll(); const outer = document.querySelector('.strip-wrap'); outer.addEventListener('mouseenter', stopHeaderScroll); outer.addEventListener('mouseleave', startHeaderScroll);
  }catch(e){ console.error(e); $('schoolStrip').innerHTML = '<div class="school-chip">Unable to load</div>' }
}

/* init */
$('year')?.parentNode && ($('year').innerText = new Date().getFullYear());
showTab = name => { $('feeContainer').style.display = name==='fee' ? 'block':'none'; $('marksContainer').parentNode.style.display = name==='marks' ? 'block':'none'; $('tabFee').classList.toggle('active', name==='fee'); $('tabMarks').classList.toggle('active', name==='marks') };

async function init(){ await buildStripFromNotifications(); await loadNotifications(); await loadAndRenderTables(); }
init();
</script>
</body>
</html>
