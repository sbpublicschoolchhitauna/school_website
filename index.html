<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School Chhitauna ‚Äî Student Portal</title>
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Segoe UI,Roboto,sans-serif;color:#0f172a;background:linear-gradient(180deg,#eaf4ff,#f7fbff)}
/* Centered header */
.header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#fff;text-align:center;padding:18px 12px;border-radius:0 0 14px 14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12); position:sticky; top:0; z-index:9999;
}
.header h1{margin:0;font-size:clamp(20px,4.5vw,30px);font-weight:800;letter-spacing:0.4px}
.header .meta{margin-top:6px;font-size:14px;opacity:0.95}
.header .meta small{display:block;font-size:13px;opacity:0.9;margin-top:4px}

/* horizontal strip under header */
.school-strip-outer{overflow:hidden;width:100%;margin-top:12px;padding-bottom:8px}
.school-strip{white-space:nowrap;display:flex;gap:18px;align-items:center;will-change:transform;transform:translateX(0)}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.06);padding:6px 12px;border-radius:8px}

/* main layout */
.container{max-width:1100px;margin:14px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.search-row{display:flex;gap:8px;margin-bottom:8px}
@media(max-width:640px){.search-row{flex-direction:column} .tabbar{gap:6px}}

/* tables */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff;max-height:360px}
@media(max-width:900px){.table-wrap{max-height:300px}}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:720px}
th,td{padding:8px 10px;border-bottom:1px solid #f1f7ff;text-align:left;vertical-align:middle}
thead th{background:#f5fbff;color:var(--accent);position:sticky;top:0;z-index:1}

/* notifications */
.notify-wrap{height:220px;overflow:hidden;position:relative;border-radius:8px}
.notify-list{position:absolute;left:0;right:0;top:0;will-change:transform}
.notify-item{padding:10px 12px;border-bottom:1px solid #eef4ff;background:#fff}
.notify-item .date{font-size:12px;color:var(--accent);font-weight:700}
.notify-item .text{font-size:14px;margin-top:4px}

/* footer */
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}

/* Fix for assistant buttons */
.style-fix a.btn[data-portal="true"], .style-fix button.btn[data-portal="true"], .style-fix button.btn.search-btn {
  background: #000 !important;
  color: #fff !important;
  border: 1px solid #000 !important;
  box-shadow: none !important;
}

/* ===== TOPPER POPUP STYLES (FINAL) ===== */
.topper-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.55);
  display:none; align-items:center; justify-content:center; z-index:99999; backdrop-filter:blur(4px);
}
.topper-box{
  background:#ffffff; width:92%; max-width:520px; border-radius:18px; padding:18px 18px 22px 18px;
  text-align:center; box-shadow:0 18px 50px rgba(2,6,23,0.28); animation:popIn .42s cubic-bezier(.2,.9,.3,1); position:relative; overflow:hidden;
}
@keyframes popIn{ from{transform:translateY(20px) scale(.95);opacity:0;} to{transform:translateY(0) scale(1);opacity:1;} }
.topper-gif{ width:110px; margin-top:-10px; display:block; margin-left:auto; margin-right:auto; animation:glow 2s infinite alternate; }
@keyframes glow{ from{filter:drop-shadow(0 0 6px #00eaff);} to{filter:drop-shadow(0 0 20px #00eaff);} }
.topper-card{
  margin-top:12px;
  text-align:left;
  background:linear-gradient(180deg,#fbfeff,#f3fbff);
  padding:12px;border-radius:10px;border:1px solid #e6f4fb;
}
.topper-card .tp-name{font-weight:900;color:#083654;font-size:18px}
.topper-card .tp-meta{margin-top:6px;font-size:14px;color:#274156}
.topper-meta{margin-top:10px;font-size:13px;color:#4b5563}
.close-btn{ position:absolute; top:10px; right:12px; background:#ff3b3b; color:#fff; border:0; width:34px; height:34px; border-radius:50%; cursor:pointer; font-weight:900; font-size:16px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(255,59,59,0.18); }
.topper-footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:10px}
.toggler{font-size:13px;color:#556;display:flex;align-items:center;gap:8px}
.toggler input{transform:scale(1.02)}
@media(max-width:480px){ .topper-box{padding:14px 12px} .topper-gif{width:90px} .topper-card .tp-name{font-size:16px} .topper-card .tp-meta{font-size:13px} }
</style>
</head>
<body>

  <!-- HEADER -->
  <div class="header" role="banner" aria-label="School header">
    <h1>S.B. PUBLIC SCHOOL</h1>
    <div class="meta">
      Village Chhitauna ¬∑ Post Meghauli Kala ¬∑ Pin Code 273304
      <small>Principal ‚Äî Mr. Gajendra Yadav Sir ¬∑ Call: +91 6389259200 ¬∑ Created By ‚Äî Upendra Vishwakarma</small>
    </div>

    <div class="school-strip-outer" id="schoolStripOuter" aria-live="polite">
      <div id="schoolStrip" class="school-strip"></div>
    </div>
  </div>

  <!-- ADMISSION TICKER -->
  <div style="max-width:1100px;margin:14px auto;">
    <div style="background:linear-gradient(90deg,#9be7ff,#c7f9ff);color:#03314b;padding:12px;border-radius:10px;box-shadow:0 10px 26px rgba(3,19,43,0.10);font-weight:800">
      <div style="display:flex;align-items:center;gap:12px"><div style="font-weight:900">üì¢ ADMISSION</div><div id="admissionNewsText">Loading‚Ä¶</div></div>
    </div>
  </div>

  <!-- MAIN CONTENT (kept your structure) -->
  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2>Quick Portals</h2>
          <div style="margin-top:8px">
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec" target="_blank">Fee Portal</a>
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbzmAK3rf7ah-4BDi5BEcZeu859kPWAthpPFgsMiCbM2Gp-Do0yuS7QpzucWRssZMwqLtA/exec" target="_blank" style="margin-left:8px">Marksheet</a>
          </div>
        </div>

        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number ‡§°‡§æ‡§≤‡§ï‡§∞ Search ‡§ï‡§∞‡•á‡§Ç</div>
          <div style="margin-top:8px" class="search-row">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
            <button class="btn search-btn" onclick="searchStudent()">Search</button>
          </div>
          <div id="result"></div>
        </div>

        <div class="card">
          <h2>Student Records</h2>
          <div class="small">‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤ ‡§ï‡§∞ Fee ‡§Ø‡§æ Marksheet ‡§¶‡•á‡§ñ‡•á‡§Ç ‚Äî Mobile/Aadhar masked (last 4)‡•§</div>
          <div class="tabbar" role="tablist">
            <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee Student Details</button>
            <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet Details</button>
          </div>
          <div id="feeContainer" class="table-wrap" style="display:block">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div id="marksContainer" class="table-wrap" style="display:none;margin-top:10px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Notifications</h2>
          <div id="notifyOuter" class="notify-wrap" aria-live="polite">
            <div id="notifs" class="notify-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">¬© <span id="year"></span> S.B. PUBLIC SCHOOL ‚Äî All Rights Reserved</div>
  </div>

  <!-- ===== FINAL TOPPER POPUP (one-by-one, parents + DOB, skip empty, rotate 10s) ===== -->
  <div class="topper-overlay" id="topperPopup" role="dialog" aria-modal="true" aria-label="Topper List">
    <div class="topper-box">
      <button class="close-btn" id="topperCloseBtn" aria-label="Close topper popup">√ó</button>

      <!-- GIF: replace if you have school trophy GIF -->
      <img src="https://media.tenor.com/OpU8OkaI0s0AAAAi/trophy.gif" alt="Trophy" class="topper-gif" id="topperGif">

      <h2 style="margin:10px 0;color:#0b5ed7">üèÜ ‡§ü‡•â‡§™‡§∞ (‡§è‡§ï-‡§è‡§ï ‡§ï‡§∞‡§ï‡•á)</h2>

      <div class="topper-card" id="topperCard">
        <div class="tp-name" id="tpName">Loading‚Ä¶</div>
        <div class="tp-meta" id="tpMeta">‡§Æ‡§æ‡§§‡§æ/‡§™‡§ø‡§§‡§æ ¬∑ DOB</div>
      </div>

      <div class="topper-meta">‡§π‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° 10 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§¨‡§æ‡§¶ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã‡§ó‡§æ ‚Äî ‡§ñ‡§æ‡§≤‡•Ä ‡§ú‡§ó‡§π ‡§µ‡§æ‡§≤‡•á ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§õ‡•ã‡§°‡§º ‡§¶‡§ø‡§è ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á‡•§</div>

      <div class="topper-footer">
        <label class="toggler"><input type="checkbox" id="dontShowAgain"> ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§Æ‡§§ ‡§¶‡§ø‡§ñ‡§æ‡§ì</label>
        <div style="font-size:13px;color:#6b7280">√ó ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</div>
      </div>
    </div>
  </div>

<script>
/* ========== FINAL TOPPER SCRIPT ========== */
/* Sheet you provided: use this ID */
const SHEET_ID = "1K9EU36olQPdENJ_8wY-9AslkarnOWdrgx7F1DErnSO0";

/* candidate sheet names to try (common variants in your workbook) */
const SHEET_CANDIDATES = [
  "Marksheet Published",
  "Marksheet_Database",
  "Marksheet Published ",
  "Marksheet Published 2025",
  "Marksheet",
  "Marksheet Details",
  "Marksheet_Details",
  "Student's Details",
  "Students"
];

const ROTATE_MS = 10000; // 10 seconds

async function fetchSheetJson(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network error ' + res.status);
  const text = await res.text();
  const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}

function gvizToRecords(g){
  const cols = (g.table.cols||[]).map(c => (c.label||c.id||'').toString().trim());
  const rows = (g.table.rows||[]).map(r => r.c || []);
  return rows.map(cells => {
    const obj = {};
    for(let i=0;i<cols.length;i++){
      const cell = cells[i];
      let v = "";
      if(cell){
        if(cell.v !== undefined) v = cell.v;
        else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
      }
      obj[cols[i] || ('col'+i)] = v;
    }
    return obj;
  });
}

/* Load sheet tabs until valid records found */
async function loadValidRecords(){
  for(const sheetName of SHEET_CANDIDATES){
    try{
      const g = await fetchSheetJson(sheetName);
      if(!g || !g.table) continue;
      const headers = (g.table.cols||[]).map(c => (c.label||c.id||'').toString().trim());
      const records = gvizToRecords(g);
      if(records.length === 0) continue;

      // detect keys
      const nameKey = headers.find(h => /^(student\s*name|name|student)$/i.test(h)) || headers.find(h => /name/i.test(h)) || null;
      const fatherKey = headers.find(h => /father/i.test(h)) || headers.find(h => /‡§™‡§ø‡§§‡§æ|father name/i.test(h)) || null;
      const motherKey = headers.find(h => /mother/i.test(h)) || headers.find(h => /‡§Æ‡§æ‡§§‡§æ|mother name/i.test(h)) || null;
      const dobKey = headers.find(h => /dob|date of birth|birth/i.test(h)) || headers.find(h => /date/i.test(h)) || null;

      // If no name/dob columns, skip this sheet
      if(!nameKey || !dobKey) continue;

      const valid = [];
      records.forEach(r => {
        const name = r[nameKey] ? String(r[nameKey]).trim() : '';
        const father = fatherKey && r[fatherKey] ? String(r[fatherKey]).trim() : '';
        const mother = motherKey && r[motherKey] ? String(r[motherKey]).trim() : '';
        const dob = r[dobKey] ? String(r[dobKey]).trim() : '';

        // Skip rows missing name OR dob
        if(!name || !dob) return;
        // Skip if both parents empty (as per your instruction: "jaha khali jagah ho waha se" ‚Äî skip)
        if(!father && !mother) return;

        const parents = [];
        if(father) parents.push('Father: ' + father);
        if(mother) parents.push('Mother: ' + mother);
        valid.push({ name, parents: parents.join(' ¬∑ '), dob });
      });

      if(valid.length > 0) return { sheet: sheetName, records: valid };
    }catch(e){
      // try next
      continue;
    }
  }
  return null;
}

/* Popup controls: rotate through records every 10s */
(function(){
  const overlay = document.getElementById('topperPopup');
  const nameEl = document.getElementById('tpName');
  const metaEl = document.getElementById('tpMeta');
  const closeBtn = document.getElementById('topperCloseBtn');
  const dontShowChk = document.getElementById('dontShowAgain');
  let intervalId = null;
  let currentIndex = 0;
  let records = [];

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function canShow(){ try{ return localStorage.getItem('topper_popup_hide') !== '1'; }catch(e){ return true; } }
  function setHide(val){ try{ localStorage.setItem('topper_popup_hide', val ? '1' : '0'); }catch(e){} }

  closeBtn.addEventListener('click', function(){
    overlay.style.display = 'none';
    stopRotate();
    if(dontShowChk.checked) setHide(true);
  });
  overlay.addEventListener('click', function(ev){
    if(ev.target === overlay){ overlay.style.display = 'none'; stopRotate(); if(dontShowChk.checked) setHide(true); }
  });

  function showRecord(i){
    if(records.length === 0){
      nameEl.innerText = 'No toppers available';
      metaEl.innerText = 'Valid records not found';
      return;
    }
    const r = records[i % records.length];
    nameEl.innerHTML = escapeHtml(r.name);
    metaEl.innerHTML = (r.parents ? escapeHtml(r.parents) + ' ¬∑ ' : '') + 'DOB: ' + escapeHtml(r.dob);
  }

  function startRotate(){
    stopRotate();
    if(records.length === 0) return;
    showRecord(currentIndex);
    intervalId = setInterval(()=> {
      currentIndex = (currentIndex + 1) % records.length;
      showRecord(currentIndex);
    }, ROTATE_MS);
  }
  function stopRotate(){ if(intervalId) clearInterval(intervalId); intervalId = null; }

  async function init(){
    nameEl.innerText = 'Loading toppers‚Ä¶';
    metaEl.innerText = '‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç...';

    try{
      const result = await loadValidRecords();
      if(result && result.records && result.records.length){
        records = result.records;
        console.info('Topper records loaded from sheet:', result.sheet, 'count:', records.length);
      } else {
        // fallback static examples (must include parent & dob)
        records = [
          { name: 'Riya Sharma', parents: 'Father: Mr. Sharma ¬∑ Mother: Mrs. Sharma', dob: '05-03-2010' },
          { name: 'Aman Gupta', parents: 'Father: Mr. Gupta', dob: '12-07-2010' }
        ];
        console.info('No valid records in sheet ‚Äî using fallback.');
      }
    }catch(e){
      records = [
        { name: 'Riya Sharma', parents: 'Father: Mr. Sharma ¬∑ Mother: Mrs. Sharma', dob: '05-03-2010' },
        { name: 'Aman Gupta', parents: 'Father: Mr. Gupta', dob: '12-07-2010' }
      ];
      console.warn('Error loading sheet ‚Äî using fallback.', e);
    }

    if(canShow()){
      overlay.style.display = 'flex';
      try{ closeBtn.focus(); }catch(e){}
      startRotate();
    }
  }

  // start on DOM ready
  if(document.readyState === 'complete' || document.readyState === 'interactive') init();
  else document.addEventListener('DOMContentLoaded', init);

  // expose control
  window.TopperPopup = { show(){ overlay.style.display='flex'; startRotate(); }, hide(){ overlay.style.display='none'; stopRotate(); }, setDontShow(flag){ setHide(flag); } };
})();
</script>

<!-- Keep your existing scripts (notifications, slider, sheet loads) after this ‚Äî for safety they were present in original file. -->
<script>
/* small housekeeping: show current year (original behavior) */
document.getElementById("year").innerText = new Date().getFullYear();
</script>

</body>
</html>
