<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School Chhitauna ‚Äî Student Portal</title>

<!-- ====== styles (kept + topper styles) ====== -->
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Segoe UI,Roboto,sans-serif;color:#0f172a;background:linear-gradient(180deg,#eaf4ff,#f7fbff)}
.header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;text-align:center;padding:18px 12px;border-radius:0 0 14px 14px;box-shadow:0 6px 18px rgba(0,0,0,0.12); position:sticky; top:0; z-index:9999;}
.header h1{margin:0;font-size:clamp(20px,4.5vw,30px);font-weight:800}
.header .meta{margin-top:6px;font-size:14px;opacity:0.95}
.school-strip-outer{overflow:hidden;width:100%;margin-top:12px;padding-bottom:8px}
.school-strip{white-space:nowrap;display:flex;gap:18px;align-items:center}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.06);padding:6px 12px;border-radius:8px}
.container{max-width:1100px;margin:14px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff;max-height:360px}
@media(max-width:900px){.table-wrap{max-height:300px}}
.notify-wrap{height:220px;overflow:hidden;position:relative;border-radius:8px}
.notify-list{position:absolute;left:0;right:0;top:0;will-change:transform}
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}

/* ===== TOPPER POPUP STYLES ===== */
.topper-overlay{
  position:fixed; inset:0; background:rgba(0,0,0,0.55);
  display:none; align-items:center; justify-content:center; z-index:99999; backdrop-filter:blur(4px);
}
.topper-box{
  background:#ffffff; width:92%; max-width:480px; border-radius:18px; padding:18px 18px 22px 18px;
  text-align:center; box-shadow:0 18px 50px rgba(2,6,23,0.28); animation:popIn .42s cubic-bezier(.2,.9,.3,1); position:relative; overflow:hidden;
}
@keyframes popIn{ from{transform:translateY(20px) scale(.95);opacity:0;} to{transform:translateY(0) scale(1);opacity:1;} }
.topper-gif{ width:110px; margin-top:-10px; display:block; margin-left:auto; margin-right:auto; animation:glow 2s infinite alternate; }
@keyframes glow{ from{filter:drop-shadow(0 0 6px #00eaff);} to{filter:drop-shadow(0 0 20px #00eaff);} }
.topper-list{ margin-top:12px; text-align:left; font-size:15px; font-weight:700; color:#083654; line-height:1.45; padding:6px 10px; border-radius:10px; background:linear-gradient(180deg,#fbfeff,#f3fbff); border:1px solid #e6f4fb; }
.topper-meta{margin-top:10px;font-size:13px;color:#4b5563}
.close-btn{ position:absolute; top:10px; right:12px; background:#ff3b3b; color:#fff; border:0; width:34px; height:34px; border-radius:50%; cursor:pointer; font-weight:900; font-size:16px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(255,59,59,0.18); }
.topper-footer{display:flex;align-items:center;justify-content:space-between;margin-top:12px;gap:10px}
.toggler{font-size:13px;color:#556;display:flex;align-items:center;gap:8px}
.toggler input{transform:scale(1.02)}
@media(max-width:480px){ .topper-box{padding:14px 12px} .topper-gif{width:90px} .topper-list{font-size:14px} }
</style>
</head>
<body>

  <!-- HEADER -->
  <div class="header" role="banner" aria-label="School header">
    <h1>S.B. PUBLIC SCHOOL</h1>
    <div class="meta">
      Village Chhitauna ¬∑ Post Meghauli Kala ¬∑ Pin Code 273304
      <small>Principal ‚Äî Mr. Gajendra Yadav Sir ¬∑ Call: +91 6389259200 ¬∑ Created By ‚Äî Upendra Vishwakarma</small>
    </div>
    <div class="school-strip-outer" id="schoolStripOuter" aria-live="polite">
      <div id="schoolStrip" class="school-strip"></div>
    </div>
  </div>

  <!-- ADMISSION TICKER -->
  <div style="max-width:1100px;margin:14px auto;">
    <div style="background:linear-gradient(90deg,#9be7ff,#c7f9ff);color:#03314b;padding:12px;border-radius:10px;box-shadow:0 10px 26px rgba(3,19,43,0.10);font-weight:800">
      <div style="display:flex;align-items:center;gap:12px"><div style="font-weight:900">üì¢ ADMISSION</div><div id="admissionNewsText">Loading‚Ä¶</div></div>
    </div>
  </div>

  <!-- MAIN (kept simplified for brevity) -->
  <div class="container">
    <div class="grid">
      <div>
        <div class="card">
          <h2>Quick Portals</h2>
          <div style="margin-top:8px">
            <a class="btn" data-portal="true" href="#" target="_blank">Fee Portal</a>
            <a class="btn" data-portal="true" href="#" target="_blank" style="margin-left:8px">Marksheet</a>
          </div>
        </div>

        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number ‡§°‡§æ‡§≤‡§ï‡§∞ Search ‡§ï‡§∞‡•á‡§Ç</div>
          <div style="margin-top:8px" class="search-row">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
            <button class="btn search-btn" onclick="searchStudent()">Search</button>
          </div>
          <div id="result"></div>
        </div>

        <div class="card">
          <h2>Student Records</h2>
          <div class="small">‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤ ‡§ï‡§∞ Fee ‡§Ø‡§æ Marksheet ‡§¶‡•á‡§ñ‡•á‡§Ç ‚Äî Mobile/Aadhar masked (last 4)‡•§</div>
          <div class="tabbar" role="tablist">
            <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee Student Details</button>
            <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet Details</button>
          </div>
          <div id="feeContainer" class="table-wrap" style="display:block">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div id="marksContainer" class="table-wrap" style="display:none;margin-top:10px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Notifications</h2>
          <div id="notifyOuter" class="notify-wrap" aria-live="polite">
            <div id="notifs" class="notify-list"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">¬© <span id="year"></span> S.B. PUBLIC SCHOOL ‚Äî All Rights Reserved</div>
  </div>

  <!-- ===== TOPPER POPUP HTML ===== -->
  <div class="topper-overlay" id="topperPopup" role="dialog" aria-modal="true" aria-label="Topper List">
    <div class="topper-box">
      <button class="close-btn" id="topperCloseBtn" aria-label="Close topper popup">√ó</button>

      <!-- Replace this GIF if you want -->
      <img src="https://media.tenor.com/OpU8OkaI0s0AAAAi/trophy.gif" alt="Trophy" class="topper-gif" id="topperGif">

      <h2 style="margin:10px 0;color:#0b5ed7">üèÜ ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§ï‡•á ‡§ü‡•â‡§™‡§∞ ‚Äî 2025</h2>

      <div class="topper-list" id="topperList">
        1Ô∏è‚É£ <strong>Loading...</strong><br>
      </div>

      <div class="topper-meta">Congratulations to all students ‚Äî Proud of your hard work!</div>
      <div class="topper-footer">
        <label class="toggler"><input type="checkbox" id="dontShowAgain"> ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§Æ‡§§ ‡§¶‡§ø‡§ñ‡§æ‡§ì</label>
        <div style="font-size:13px;color:#6b7280">Tap √ó to close</div>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const SHEET_ID = "1K9EU36olQPdENJ_8wY-9AslkarnOWdrgx7F1DErnSO0"; // from your link
// candidate sheet names to try (the sheet you used shows these tabs). We'll try in order.
const SHEET_CANDIDATES = [
  "Marksheet Published",
  "Marksheet_Database",
  "Marksheet Published ", // tolerance for slight name variants
  "Marksheet Published 2025",
  "Marksheet Published  2025",
  "Marksheet_Published",
  "MarksheetPublished",
  "Marksheet"
];
const TOP_COUNT = 5; // how many toppers to show

/* helper to fetch sheet via gviz */
async function fetchSheetJson(sheetName){
  const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;
  const q = `sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const url = base + q;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const txt = await res.text();
  // the response is like: "/*O_o*/\ngoogle.visualization.Query.setResponse({...});"
  const jsonText = txt.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}

/* find best header for percent/total */
function findScoreHeader(headers){
  const normals = headers.map(h => (h||'').toString().trim().toLowerCase());
  // common candidates
  const candidates = ['percentage','percent','total %','percent %','percentile','overall %','percentage (%)','percentage%','total percentage','total%','percent'];
  for(const c of candidates){
    const idx = normals.findIndex(h => h===c || h.includes(c));
    if(idx !== -1) return headers[idx];
  }
  // fallback: header that contains 'total' or 'obt' or 'marks'
  for(let i=0;i<normals.length;i++){
    if(/total|marks|obtained|obtain|obt/i.test(headers[i])) return headers[i];
  }
  return null;
}

/* convert gviz table to array of objects */
function gvizToRecords(gviz){
  const cols = (gviz.table.cols||[]).map(c => (c.label||c.id||'').toString().trim());
  const rows = (gviz.table.rows||[]).map(r => r.c || []);
  return rows.map(cells => {
    const obj = {};
    for(let i=0;i<cols.length;i++){
      const cell = cells[i];
      let v = "";
      if(cell){
        if(cell.v !== undefined) v = cell.v;
        else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
      }
      obj[cols[i] || ('col'+i)] = v;
    }
    return obj;
  });
}

/* try candidate sheets and pick toppers */
async function loadToppersFromSheet(){
  for(const sheetName of SHEET_CANDIDATES){
    try{
      const g = await fetchSheetJson(sheetName);
      if(!g || !g.table) continue;
      const headers = (g.table.cols||[]).map(c => (c.label||c.id||'').toString().trim());
      const records = gvizToRecords(g);
      if(records.length === 0) continue;

      // determine score column
      const scoreHeader = findScoreHeader(headers);
      // If score header not found, try common explicit names
      const possibleNames = ['Percentage','Percent','Percent %','Total Percentage','Total%','totalObt','Total','Marks','Total Marks'];
      const scoreCol = scoreHeader || headers.find(h => possibleNames.some(p => (h||'').toLowerCase().includes(p.toLowerCase())));
      // Build array with numeric score where possible
      const arr = records.map(r => {
        const nameKeys = Object.keys(r).filter(k => /name|student|student name|student_name|sname/i.test(k));
        const name = (nameKeys.length ? (r[nameKeys[0]] || '') : (r['Student']||r['Name']||r['Student Name']||'')).toString();
        let scoreRaw = scoreCol ? (r[scoreCol] || '') : (r['Percentage'] || r['percent'] || r['Total'] || r['Total Marks'] || '');
        let scoreNum = null;
        if(scoreRaw !== null && scoreRaw !== undefined && String(scoreRaw).trim() !== ""){
          const s = String(scoreRaw).replace(/[^0-9.\-]/g,'');
          scoreNum = s ? Number(s) : null;
        }
        return { name: name, scoreRaw: scoreRaw, score: scoreNum, row: r };
      });

      // filter those with number scores; if none have numeric scores, fallback to string sorting
      const withNum = arr.filter(x => typeof x.score === 'number' && !isNaN(x.score));
      let sorted;
      if(withNum.length > 0){
        sorted = arr.sort((a,b) => (b.score || 0) - (a.score || 0));
      } else {
        // sort by scoreRaw as string (desc) and use name as tiebreak
        sorted = arr.sort((a,b) => String(b.scoreRaw||'').localeCompare(String(a.scoreRaw||'')));
      }
      // take top TOP_COUNT where name exists
      const toppers = sorted.filter(x => (x.name && String(x.name).trim() !== "")).slice(0, TOP_COUNT).map((t, idx) => {
        const displayScore = (t.scoreRaw!==undefined && t.scoreRaw!==null && String(t.scoreRaw).trim()!=='') ? String(t.scoreRaw) : (t.score!==null ? String(t.score) : '');
        return { rank: idx+1, name: (t.name||'-'), score: displayScore };
      });

      if(toppers.length > 0){
        return { sheet: sheetName, toppers };
      } else {
        // continue to next sheet candidate
      }
    }catch(err){
      // ignore and try next candidate
      // console.warn("Sheet fetch failed for", sheetName, err);
      continue;
    }
  }
  // nothing found
  return null;
}

/* ====== Popup render + behavior ====== */
(function(){
  const overlay = document.getElementById('topperPopup');
  const listEl = document.getElementById('topperList');
  const closeBtn = document.getElementById('topperCloseBtn');
  const dontShowChk = document.getElementById('dontShowAgain');

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function renderStaticFallback(){
    const staticList = [
      {rank:1, name:"Riya Sharma", score:"98%"},
      {rank:2, name:"Aman Gupta", score:"97%"},
      {rank:3, name:"Priya Singh", score:"96%"},
      {rank:4, name:"Arjun Yadav", score:"95%"}
    ];
    const html = staticList.map(t => `${t.rank}Ô∏è‚É£ <strong>${escapeHtml(t.name)}</strong> ‚Äî ${escapeHtml(t.score)}`).join('<br>');
    listEl.innerHTML = html;
  }

  function renderToppers(toppers){
    if(!Array.isArray(toppers) || toppers.length===0){ renderStaticFallback(); return; }
    const html = toppers.map(t => `${t.rank}Ô∏è‚É£ <strong>${escapeHtml(t.name)}</strong>${t.score? ' ‚Äî ' + escapeHtml(t.score) : ''}`).join('<br>');
    listEl.innerHTML = html;
  }

  function canShow(){ try{ return localStorage.getItem('topper_popup_hide') !== '1'; }catch(e){ return true; } }
  function setHide(val){ try{ localStorage.setItem('topper_popup_hide', val ? '1' : '0'); }catch(e){} }

  closeBtn.addEventListener('click', function(){
    overlay.style.display = 'none';
    if(dontShowChk.checked) setHide(true);
  });
  overlay.addEventListener('click', function(ev){
    if(ev.target === overlay){ overlay.style.display = 'none'; if(dontShowChk.checked) setHide(true); }
  });

  async function init(){
    renderStaticFallback(); // show something while loading
    try{
      const result = await loadToppersFromSheet();
      if(result && result.toppers && result.toppers.length){
        renderToppers(result.toppers);
        console.info("Loaded toppers from sheet:", result.sheet);
      } else {
        console.info("No toppers found in sheet; using fallback.");
        renderStaticFallback();
      }
    }catch(e){
      console.warn("Error loading toppers:", e);
      renderStaticFallback();
    }

    // show popup after small delay if allowed
    if(!canShow()) return;
    setTimeout(()=>{ overlay.style.display = 'flex'; try{ closeBtn.focus(); }catch(e){} }, 700);
  }

  // expose API
  window.TopperPopup = { show(){ overlay.style.display = 'flex'; }, hide(){ overlay.style.display = 'none'; }, setDontShow(flag){ setHide(flag); } };

  // kick off
  if(document.readyState === 'complete' || document.readyState === 'interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>

<!-- small script to set year -->
<script>document.getElementById("year").innerText = new Date().getFullYear();</script>
</body>
</html>
