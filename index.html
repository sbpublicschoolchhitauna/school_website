<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School Chhitauna ‚Äî Student Portal</title>
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Segoe UI,Roboto,sans-serif;color:#0f172a;background:linear-gradient(180deg,#eaf4ff,#f7fbff)}
/* Centered header */
.header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#fff;text-align:center;padding:18px 12px;border-radius:0 0 14px 14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12); position:sticky; top:0; z-index:9999;
}
.header h1{margin:0;font-size:clamp(20px,4.5vw,30px);font-weight:800;letter-spacing:0.4px}
.header .meta{margin-top:6px;font-size:14px;opacity:0.95}
.header .meta small{display:block;font-size:13px;opacity:0.9;margin-top:4px}

/* horizontal strip under header */
.school-strip-outer{overflow:hidden;width:100%;margin-top:12px;padding-bottom:8px}
.school-strip{white-space:nowrap;display:flex;gap:18px;align-items:center;will-change:transform;transform:translateX(0)}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.06);padding:6px 12px;border-radius:8px}

/* main layout */
.container{max-width:1100px;margin:14px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.search-row{display:flex;gap:8px;margin-bottom:8px}
@media(max-width:640px){.search-row{flex-direction:column} .tabbar{gap:6px}}

/* tables */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff;max-height:360px}
@media(max-width:900px){.table-wrap{max-height:300px}}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:720px}
th,td{padding:8px 10px;border-bottom:1px solid #f1f7ff;text-align:left;vertical-align:middle}
thead th{background:#f5fbff;color:var(--accent);position:sticky;top:0;z-index:1}

/* notifications */
.notify-wrap{height:220px;overflow:hidden;position:relative;border-radius:8px}
.notify-list{position:absolute;left:0;right:0;top:0;will-change:transform}
.notify-item{padding:10px 12px;border-bottom:1px solid #eef4ff;background:#fff}
.notify-item .date{font-size:12px;color:var(--accent);font-weight:700}
.notify-item .text{font-size:14px;margin-top:4px}

/* footer */
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}
</style>

<style id="assistant-button-fix">
/* Make Quick Portals and Search buttons clearly visible */
a.btn[data-portal="true"], button.btn[data-portal="true"], button.btn.search-btn {
  background: #000 !important;
  color: #fff !important;
  border: 1px solid #000 !important;
  box-shadow: none !important;
}
/* Ensure slider controls remain light */
.slider-wrap .btn { background: rgba(255,255,255,0.9); color: #000; }
</style>

</head>
<body>

  <!-- CENTERED HEADER -->
  <div class="header" role="banner" aria-label="School header">
    <h1>S.B. PUBLIC SCHOOL</h1>
    <div class="meta">
      Village Chhitauna ¬∑ Post Meghauli Kala ¬∑ Pin Code 273304
      <small>Principal ‚Äî Mr. Gajendra Yadav Sir ¬∑ Call: +91 6389259200 ¬∑ Created By ‚Äî Upendra Vishwakarma</small>
    </div>

    <!-- horizontal strip populated from Notification sheet -->
    <div class="school-strip-outer" id="schoolStripOuter" aria-live="polite">
      <div id="schoolStrip" class="school-strip"></div>
    </div>
  </div>

  <!-- ====== ADMISSION TICKER (premium, eye-friendly gradient, multiple rotating messages) ====== -->
  <style>
  /* Eye-friendly soft blue-cyan gradient, subtle 3D */
  .admission-news-bar{
    width:100%;
    background:linear-gradient(90deg,#9be7ff,#c7f9ff);
    color:#03314b;
    padding:12px 0;
    font-weight:800;
    font-size:16px;
    overflow:hidden;
    position:relative;
    border-radius:10px;
    margin:14px auto;
    max-width:1100px;
    box-shadow:0 10px 26px rgba(3,19,43,0.10), inset 0 -4px 14px rgba(0,0,0,0.03);
    transform:translateZ(0);
    perspective:800px;
  }
  .admission-news-inner{
    position:relative;
    transform-origin:center;
    transform: translateZ(0) rotateX(0.3deg);
    max-width:calc(100% - 28px);
    margin:0 14px;
  }
  .admission-news-text{
    display:inline-block;
    white-space:nowrap;
    padding-left:1rem;
    will-change:transform,opacity;
    color:#012032;
    font-weight:800;
  }
  .admission-news-ghost{
    position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:0.06;
    background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.6) 50%,transparent 100%);
  }
  .admission-news-meta{
    display:flex;align-items:center;gap:12px;overflow:hidden;padding:0 4px;
  }
  .admission-tag{
    background:rgba(1,48,62,0.06);padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;border:1px solid rgba(1,48,62,0.04);color:#012032;
  }
  @media(max-width:640px){ .admission-news-bar{font-size:14px;padding:10px 0} .admission-tag{display:none} }
  </style>

  <div class="admission-news-bar" role="region" aria-label="Admission news ticker" tabindex="0" id="admissionTickerWrap">
    <div class="admission-news-inner">
      <div class="admission-news-meta">
        <div class="admission-tag">üì¢ ADMISSION</div>
        <div class="admission-news-text" id="admissionNewsText" aria-live="polite"></div>
      </div>
      <div class="admission-news-ghost" aria-hidden="true"></div>
    </div>
  </div>

  <!-- ====== QUICK PORTALS / SEARCH / RECORDS / NOTIFICATIONS ====== -->
  <div class="container">
    <div class="grid">
      <div>

        <div class="card">
          <h2>Quick Portals</h2>
          <div style="margin-top:8px">
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec" target="_blank">Fee Portal</a>
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbzmAK3rf7ah-4BDi5BEcZeu859kPWAthpPFgsMiCbM2Gp-Do0yuS7QpzucWRssZMwqLtA/exec" target="_blank" style="margin-left:8px">Marksheet</a>
          </div>
        </div>

        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number ‡§°‡§æ‡§≤‡§ï‡§∞ Search ‡§ï‡§∞‡•á‡§Ç</div>
          <div style="margin-top:8px" class="search-row">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
            <button class="btn search-btn" data-portal="true" onclick="searchStudent()">Search</button>
          </div>
          <div id="result"></div>
        </div>

        <div class="card">
          <h2>Student Records</h2>
          <div class="small">‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤ ‡§ï‡§∞ Fee ‡§Ø‡§æ Marksheet ‡§¶‡•á‡§ñ‡•á‡§Ç ‚Äî Mobile/Aadhar masked (last 4)‡•§</div>
          <div class="tabbar" role="tablist">
            <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee Student Details</button>
            <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet Details</button>
          </div>
          <div id="feeContainer" class="table-wrap" style="display:block">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div id="marksContainer" class="table-wrap" style="display:none;margin-top:10px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>

      </div>

      <div>
        <div class="card">
          <h2>Notifications</h2>
          <div id="notifyOuter" class="notify-wrap" aria-live="polite">
            <div id="notifs" class="notify-list"></div>
          </div>
        </div>
      </div>

    </div>

    <div class="footer">¬© <span id="year"></span> S.B. PUBLIC SCHOOL ‚Äî All Rights Reserved</div>
  </div>

  <!-- ====== SLIDER (kept as before) ====== -->
  <div class="slider-wrap" id="sliderWrap" aria-label="School photo slider (fade)">
    <button class="play-toggle" id="playToggle" aria-pressed="false">Pause</button>
    <div class="slider" id="slider" role="region" aria-roledescription="carousel"></div>
    <div class="controls">
      <button class="btn slider-control" id="prev" aria-label="Previous">‚Äπ</button>
      <button class="btn slider-control" id="next" aria-label="Next">‚Ä∫</button>
    </div>
    <div class="dots" id="dots" role="tablist" aria-label="Slide dots"></div>
  </div>

<!-- ====== BIGGER TOPPERS 3D AUTO-UPDATE POPUP (FINAL) ====== -->
<style>
/* Larger 3D card popup */
.topper-3d-wrap{
  position:fixed;
  right:28px;
  bottom:28px;
  width:460px;
  max-width:calc(100% - 32px);
  z-index:14000;
  perspective:1400px;
  pointer-events:auto;
}
.topper-3d {
  transform-style:preserve-3d;
  background:linear-gradient(180deg, rgba(255,255,255,0.99), rgba(246,249,255,0.99));
  border-radius:14px;
  padding:16px 18px;
  box-shadow: 0 36px 80px rgba(6,20,40,0.22);
  border:1px solid rgba(2,18,40,0.06);
  will-change: transform, box-shadow;
  transition: transform 420ms cubic-bezier(.2,.9,.2,1), box-shadow 420ms;
  transform-origin:center;
  display:flex;
  gap:14px;
  align-items:flex-start;
}
.topper-3d .left{
  width:96px;
  flex:0 0 96px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.topper-3d .photo{
  width:88px;height:88px;border-radius:12px;background:linear-gradient(180deg,#eef6ff,#ffffff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b5fa8;border:1px solid rgba(11,95,168,0.06);overflow:hidden;
  box-shadow: 0 12px 30px rgba(6,20,40,0.08);
}
.topper-3d .photo img{width:100%;height:100%;object-fit:cover;display:block}

/* right content bigger */
.topper-3d .right{flex:1;min-width:0}
.topper-3d .head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.topper-3d .title{font-weight:900;color:#032a3a;font-size:18px;line-height:1.05}
.topper-3d .badge{background:linear-gradient(90deg,#ffd36b,#ff9b6b);padding:8px 12px;border-radius:999px;font-weight:900;color:#2b1600;font-size:13px}
.topper-3d .body{margin-top:10px}
.topper-3d .row{display:flex;justify-content:space-between;gap:8px;margin-top:8px;align-items:center}
.topper-3d .label{color:#556b73;font-size:13px;min-width:110px}
.topper-3d .value{font-weight:800;color:#042e38;font-size:15px;text-align:right;word-break:break-word}
.topper-3d .meta{margin-top:10px;font-size:13px;color:#586f78;display:flex;justify-content:space-between;gap:8px;align-items:center}
.topper-3d .meta .small{font-size:12px;color:#6b7a83}

/* floating depth animation stronger */
.topper-3d:hover{ transform: translateY(-10px) rotateX(6deg) rotateY(3deg); box-shadow: 0 42px 90px rgba(6,20,40,0.28); }

/* close button (bigger) */
.topper-close{position:absolute;left:12px;top:12px;border:0;background:transparent;font-weight:800;color:#444;cursor:pointer;font-size:16px}

/* responsive */
@media(max-width:600px){
  .topper-3d-wrap{left:12px; right:12px; bottom:18px; width:auto}
  .topper-3d{flex-direction:row; padding:12px}
  .topper-3d .label{min-width:90px;font-size:12px}
  .topper-3d .value{font-size:14px}
  .topper-3d .photo{width:72px;height:72px}
}
</style>

<div id="topper3dWrap" class="topper-3d-wrap" style="display:none" aria-live="polite" role="status">
  <div class="topper-3d" id="topper3dCard" tabindex="0">
    <button id="topper3dClose" class="topper-close" aria-label="Close">‚úï</button>

    <div class="left">
      <div class="photo" id="t3_photo">Photo</div>
    </div>

    <div class="right">
      <div class="head">
        <div class="title" id="t3_title">üéâ Topper ‚Äî Class</div>
        <div class="badge" id="t3_badge">CONGRATS</div>
      </div>

      <div class="body" id="t3_body">
        <div class="row"><div class="label">Name</div><div class="value" id="t3_name">‚Äî</div></div>
        <div class="row"><div class="label">Class</div><div class="value" id="t3_class">‚Äî</div></div>
        <div class="row"><div class="label">Father</div><div class="value" id="t3_father">‚Äî</div></div>
        <div class="row"><div class="label">Mother</div><div class="value" id="t3_mother">‚Äî</div></div>
        <div class="row"><div class="label">DOB</div><div class="value" id="t3_dob">‚Äî</div></div>
        <div class="row"><div class="label">Admission No</div><div class="value" id="t3_adm">‚Äî</div></div>
        <div class="row"><div class="label">Score</div><div class="value" id="t3_score">‚Äî</div></div>

        <div class="meta">
          <div class="small">From: <strong id="t3_sheet">‚Äî</strong></div>
          <div class="small">Auto-refresh: <strong id="t3_interval">30s</strong></div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ====== END TOPPERS 3D ====== -->

<script>
/* ========== Generic helpers and core page scripts ========== */

/* small helper */
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* Slider images (same fallback list) */
async function loadImagesDynamic(){
  try{ const res = await fetch('/api/images'); if(res.ok){ const j = await res.json(); if(Array.isArray(j.images) && j.images.length) return j.images; } }catch(e){}
  try{ const res2 = await fetch('images.json'); if(res2.ok){ const j2 = await res2.json(); if(Array.isArray(j2.images) && j2.images.length) return j2.images; } }catch(e){}
  return [
    'slider_images/WhatsApp Image 2025-11-16 at 10.33.37_c4bd2e68.jpg',
    'slider_images/WhatsApp Image 2025-10-30 at 19.36.04_e42049db.jpg',
    'slider_images/WhatsApp Image 2025-11-16 at 10.33.39_5f42559c.jpg',
    'slider_images/WhatsApp Image 2025-11-16 at 10.33.38_3193ced1.jpg',
    'slider_images/WhatsApp Image 2025-10-30 at 19.35.04_d1684284.jpg',
    'slider_images/WhatsApp Image 2025-10-30 at 19.36.05_6d3a2a2d.jpg',
    'slider_images/WhatsApp Image 2025-10-30 at 19.36.04_66cb599d.jpg',
    'slider_images/WhatsApp Image 2025-11-16 at 10.33.48_b61cc87d.jpg',
    'slider_images/WhatsApp Image 2025-11-16 at 10.33.47_3953b4e7.jpg',
    'slider_images/WhatsApp Image 2024-09-09 at 11.13.17_4b384d82.jpg',
    'slider_images/WhatsApp Image 2024-09-09 at 11.13.16_040cf6d0.jpg',
    'slider_images/logo.jpg',
  ];
}

let IMAGES = [];
let slides = [];
let index = 0;
let sliderTimer = null;
let sliderInterval = 4000;

async function initSlider(){
  IMAGES = await loadImagesDynamic();
  const slider = document.getElementById('slider');
  const dotsWrap = document.getElementById('dots');
  IMAGES.forEach((src,i)=>{
    const s = document.createElement('div');
    s.className = 'slide';
    s.style.position = 'absolute';
    s.style.inset = '0';
    s.style.opacity = '0';
    s.style.transition = 'opacity .8s ease';
    const img = document.createElement('img');
    img.src = src;
    img.alt = `School photo ${i+1}`;
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.objectFit = 'cover';
    s.appendChild(img);
    slider.appendChild(s);
    slides.push(s);
    const d = document.createElement('button');
    d.className = 'dot';
    d.setAttribute('aria-label', 'Go to slide ' + (i+1));
    d.addEventListener('click', ()=>{ pauseSlider(); goToSlide(i); });
    dotsWrap.appendChild(d);
  });
  if(slides[0]) slides[0].style.opacity = '1';
  updateDots();
  startSlider();
}
function adjustHeightTo(img){
  const slider = document.getElementById('slider');
  const sliderWrap = document.getElementById('sliderWrap');
  const wrapWidth = slider.clientWidth || sliderWrap.clientWidth;
  if(!img.naturalWidth) return;
  const h = Math.round((img.naturalHeight / img.naturalWidth) * wrapWidth);
  const maxH = Math.round(window.innerHeight * 0.65);
  const finalH = Math.min(h, maxH);
  slider.style.height = finalH + 'px';
}
function goToSlide(i){
  index = (i + slides.length) % slides.length;
  slides.forEach((s, idx)=> s.style.opacity = (idx===index)? '1' : '0');
  updateDots();
}
function nextSlide(){ goToSlide(index+1); }
function prevSlide(){ goToSlide(index-1); }
function updateDots(){
  const dots = document.getElementById('dots').children;
  for(let i=0;i<dots.length;i++){ dots[i].classList.toggle('active', i===index); }
}
function startSlider(){ if(sliderTimer) clearInterval(sliderTimer); sliderTimer = setInterval(nextSlide, sliderInterval); document.getElementById('playToggle').textContent='Pause'; }
function pauseSlider(){ if(sliderTimer) clearInterval(sliderTimer); sliderTimer=null; document.getElementById('playToggle').textContent='Play'; }
document.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ pauseSlider(); nextSlide(); } else if(e.key==='ArrowLeft'){ pauseSlider(); prevSlide(); } });
document.getElementById('prev').addEventListener('click', ()=>{ pauseSlider(); prevSlide(); });
document.getElementById('next').addEventListener('click', ()=>{ pauseSlider(); nextSlide(); });
document.getElementById('playToggle').addEventListener('click', ()=>{ if(sliderTimer) pauseSlider(); else startSlider(); });
window.addEventListener('resize', ()=>{ setTimeout(()=>{ const img = slides[index] && slides[index].querySelector('img'); if(img && img.complete) adjustHeightTo(img); }, 140); });

initSlider();

/* ====== Google Sheet helpers used by many features ====== */
// NOTE: the main "table data" features (Fee/Marksheet/Notifications/Search) use THIS SHEET_ID:
const SHEET_ID = "1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8";

async function loadSheetGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const text = await res.text();
  const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}

function maskLast4(val){
  if(val===null||val===undefined) return "";
  const s = String(val).trim();
  const digits = s.replace(/\D/g,'');
  if(digits.length === 0) return '';
  const last4 = digits.slice(-4);
  return '****' + last4;
}
function isMobileHeader(h){ return /mobile|phone|contact|mob/i.test(h); }
function isAadharHeader(h){ return /aadhar|aadhaar|uid/i.test(h); }

/* Render table */
function renderTableTo(containerId, gvizJson){
  const cols = (gvizJson.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
  const rows = (gvizJson.table.rows||[]).map(r=> r.c || []);
  const wrap = document.getElementById(containerId);
  if(rows.length === 0){
    wrap.innerHTML = "<div style='padding:12px;color:#666'>‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>";
    return;
  }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(h=>{
    const th = document.createElement('th');
    th.innerText = h || '';
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    for(let i=0;i<cols.length;i++){
      const cell = r[i];
      let v = "";
      if(cell){
        if(cell.f !== undefined && String(cell.f).trim()!=='') v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        else if(cell.v !== undefined) v = cell.v;
      }
      const header = cols[i]||'';
      if(isMobileHeader(header)) v = maskLast4(v);
      if(isAadharHeader(header)) v = maskLast4(v);
      const td = document.createElement('td');
      td.innerText = v;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML = "";
  wrap.appendChild(table);
}

/* Tabs */
function showTab(name){
  document.getElementById('feeContainer').style.display = name==='fee' ? 'block' : 'none';
  document.getElementById('marksContainer').style.display = name==='marks' ? 'block' : 'none';
  document.getElementById('tabFee').classList.toggle('active', name==='fee');
  document.getElementById('tabMarks').classList.toggle('active', name==='marks');
}

/* Search student */
async function searchStudent(){
  const adm = document.getElementById("admission").value.trim();
  if(!adm) return alert("Admission Number ‡§°‡§æ‡§≤‡•á‡§Ç");
  try{
    const data = await loadSheetGviz("Student's Details");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]||('col'+i)] = v;
      }
      return obj;
    });

    const admKeys = ["Admission No.","Adm. No.","Admission Number","Adm No","Admission No"];
    const rec = records.find(r => admKeys.some(k=> String((r[k]||'')).trim() === adm || String((r[k]||'')).trim() === ("0"+adm)));
    const out = document.getElementById("result");
    out.style.display = 'block';
    if(!rec){
      out.innerHTML = "<div style='padding:12px;background:#fff;border-radius:8px;border:1px solid #f1f7ff'>No details found for this Admission Number.</div>";
      return;
    }

    const fields = ["Student Name","Father Name","Mother Name","Date of Birth","Class","Address"];
    let html = '<div style="padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ff">';
    fields.forEach(f=>{
      html += `<div style="margin-bottom:8px"><strong>${f}:</strong> ${escapeHtml(rec[f]||'')}</div>`;
    });
    html += '</div>';
    out.innerHTML = html;

  }catch(e){
    console.error("Search error", e);
    alert("Search ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‚Äî console ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
  }
}

/* Notifications vertical scroll */
let notifRAF = null;
let notifPos = 0;
function startNotifScroll(){
  const wrap = document.getElementById('notifs');
  if(!wrap) return;
  cancelAnimationFrame(notifRAF);
  function step(){
    notifPos -= 0.45;
    const half = wrap.scrollHeight/2 || 0;
    if(Math.abs(notifPos) >= half) notifPos = 0;
    wrap.style.transform = `translateY(${notifPos}px)`;
    notifRAF = requestAnimationFrame(step);
  }
  step();
}
function stopNotifScroll(){ if(notifRAF) cancelAnimationFrame(notifRAF); notifRAF = null; }

/* Header horizontal scroll */
let headerRAF = null;
let headerPos = 0;
function startHeaderScroll(){
  const strip = document.getElementById('schoolStrip');
  if(!strip) return;
  cancelAnimationFrame(headerRAF);
  function step(){
    headerPos -= 0.6;
    const half = strip.scrollWidth/2 || 0;
    if(Math.abs(headerPos) >= half) headerPos = 0;
    strip.style.transform = `translateX(${headerPos}px)`;
    headerRAF = requestAnimationFrame(step);
  }
  step();
}
function stopHeaderScroll(){ if(headerRAF) cancelAnimationFrame(headerRAF); headerRAF = null; }

/* Build header strip from Notification sheet */
async function buildStripFromNotifications(){
  try{
    const data = await loadSheetGviz("Notification");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k)) || cols[1] || cols[0] || 'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k)) || cols[0] || 'Date';
    const strip = document.getElementById('schoolStrip');
    strip.innerHTML = "";
    const items = [];
    rows.forEach(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]] = v;
      }
      const t = obj[textKey] || '';
      const d = obj[dateKey] || '';
      if(t || d) items.push({date: d, text: t});
    });
    if(items.length === 0){
      const span = document.createElement('div'); span.className='school-chip'; span.innerText = 'No notifications to show.'; strip.appendChild(span); return;
    }
    function makeChip(it){
      const txt = (it.date ? (it.date + ' - ') : '') + it.text;
      const short = txt.length > 120 ? txt.slice(0,117)+'...' : txt;
      const span=document.createElement('div');
      span.className='school-chip';
      span.title = txt;
      span.innerText = short;
      return span;
    }
    items.forEach(it=> strip.appendChild(makeChip(it)));
    items.forEach(it=> strip.appendChild(makeChip(it)));
    startHeaderScroll();
    const outer = document.getElementById('schoolStripOuter');
    outer.addEventListener('mouseenter', stopHeaderScroll);
    outer.addEventListener('mouseleave', startHeaderScroll);
  }catch(e){
    console.error('Strip build error', e);
    const strip = document.getElementById('schoolStrip');
    strip.innerHTML = '<div class="school-chip">Unable to load header notifications ‚Äî check sheet name and sharing.</div>';
  }
}

/* load notifications vertical */
async function loadNotifications(){
  try{
    const data = await loadSheetGviz("Notification");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k)) || cols[1] || cols[0] || 'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k)) || cols[0] || 'Date';
    const wrap = document.getElementById('notifs');
    wrap.innerHTML = "";
    rows.forEach(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]] = v;
      }
      const d = obj[dateKey] || '';
      const t = obj[textKey] || '';
      const node = document.createElement('div');
      node.className = 'notify-item';
      node.innerHTML = `<div class="date">${escapeHtml(d)}</div><div class="text">${escapeHtml(t)}</div>`;
      wrap.appendChild(node);
    });
    const orig = wrap.children.length;
    for(let i=0;i<orig;i++){ wrap.appendChild(wrap.children[i].cloneNode(true)); }
    startNotifScroll();
    const outer = document.getElementById('notifyOuter');
    outer.addEventListener('mouseenter', stopNotifScroll);
    outer.addEventListener('mouseleave', startNotifScroll);
  }catch(e){
    console.error('Notification load error', e);
    document.getElementById('notifs').innerHTML = '<div style="padding:12px;color:#c33">Notification ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>';
  }
}

/* load fee and marks */
async function loadFeeAndMarks(){
  try{
    const feeJson = await loadSheetGviz("Fee Student Details");
    renderTableTo("feeContainer", feeJson);
  }catch(e){
    console.error(e);
    document.getElementById("feeContainer").innerHTML = "<div style='padding:12px;color:#c33'>Fee Student Details ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>";
  }
  try{
    const marksJson = await loadSheetGviz("Marksheet Details");
    renderTableTo("marksContainer", marksJson);
  }catch(e){
    console.error(e);
    document.getElementById("marksContainer").innerHTML = "<div style='padding:12px;color:#c33'>Marksheet Details ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>";
  }
}

/* INIT */
document.getElementById("year").innerText = new Date().getFullYear();
showTab('fee');
buildStripFromNotifications();
loadNotifications();
loadFeeAndMarks();

/* Admission ticker (keeps same messages, can be changed) */
(function(){
  const NEWS = [
    'ADMISSION OPEN ‚Äì APRIL 2025 ¬∑ Nursery to Class 10 ¬∑ Limited Seats ‚Äî Apply Now',
    'Registration: Mon‚ÄìSat 8:30 AM ‚Äì 3:00 PM ¬∑ Documents: Birth Certificate, Aadhar (if any)',
    'Special Scholarship for Meritorious Students ‚Äî Contact Principal Office',
    'School Timings: 8:30 AM to 3:00 PM ¬∑ Transport Available ¬∑ Call +91 6389259200'
  ];
  const el = document.getElementById('admissionNewsText');
  if(!el) return;
  let idx = 0;

  function startMessage(i){
    const msg = NEWS[i];
    el.textContent = msg + ' \u00A0 \u00A0 \u00A0 ' + msg;
    void el.offsetWidth;
    const containerWidth = el.parentElement.clientWidth || 600;
    const textWidth = Math.max(el.scrollWidth / 2, 200);
    const baseMs = 14000;
    const pxFactor = 9;
    const duration = Math.max(9000, Math.round(baseMs + (textWidth * pxFactor)));

    el.style.transition = 'none';
    el.style.transform = `translateX(${containerWidth}px)`;

    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        el.style.transition = `transform ${duration}ms linear`;
        el.style.transform = `translateX(-${textWidth}px)`;
      });
    });

    clearTimeout(el._nextTimeout);
    el._nextTimeout = setTimeout(()=>{
      idx = (i + 1) % NEWS.length;
      setTimeout(()=> startMessage(idx), 700);
    }, duration + 200);
  }

  const wrap = document.getElementById('admissionTickerWrap');
  function pauseTicker(){
    const style = window.getComputedStyle(el);
    const matrix = style.transform || style.webkitTransform || '';
    let tx = 0;
    if(matrix && matrix !== 'none'){
      try{
        const vals = matrix.match(/matrix\(([^)]+)\)/);
        if(vals){ const parts = vals[1].split(','); tx = parseFloat(parts[4]); }
      }catch(e){}
    }
    el.style.transition = 'none';
    el.style.transform = `translateX(${tx}px)`;
    clearTimeout(el._nextTimeout);
  }
  function resumeTicker(){ startMessage(idx); }

  wrap.addEventListener('mouseenter', pauseTicker);
  wrap.addEventListener('focusin', pauseTicker);
  wrap.addEventListener('mouseleave', resumeTicker);
  wrap.addEventListener('focusout', resumeTicker);

  startMessage(0);
})();
</script>

<!-- ====== BIGGER TOPPERS 3D AUTO-UPDATE SCRIPT (FINAL) ====== -->
<script>
/*
  Uses the UNIT sheets you provided (UNIT 1, UNIT 2, HALF YEARLY, UNIT 4, ANNUAL).
  Matches Admission No robustly and looks up Student Details from public sheets.
  THIS SCRIPT uses the SHEET_ID you gave earlier for toppers data:
*/
(async function(){
  // this is the sheet id you provided for student/unit data (Upendra's sheet)
  const SHEET_ID_TOPPERS = '1K9EU36olQPdENJ_8wY-9AslkarnOWdrgx7F1DErnSO0';

  const unitSheets = ['UNIT 1','UNIT 2','HALF YEARLY','UNIT 4','ANNUAL'];
  const studentLookupCandidates = [
    "Student's Details","Students","Student Details","Students Database","Marksheet Details","Marksheet"
  ];

  const REFRESH_MS = 30000;
  const SHOW_MS = 4200;

  const admRegex = /^(admission|adm|admn|admission no|admission number|adm no|roll|roll no)/i;
  const classRegex = /^(class|std|standard|section)/i;
  const scoreRegex = /^(score|marks|total|percentage|percent|obtained|result|aggregate)/i;
  const nameRegex = /(name|student name|candidate)/i;

  async function fetchGviz(sheetId, sheetName){
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
    try{
      const r = await fetch(url);
      if(!r.ok) throw new Error('not ok ' + r.status);
      const txt = await r.text();
      const jsonText = txt.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
      return JSON.parse(jsonText);
    }catch(e){
      return null;
    }
  }

  function normAdm(s){
    if(s===null||s===undefined) return '';
    const d = String(s).replace(/\D/g,'');
    if(d==='') return '';
    return d.replace(/^0+/, '') || '0';
  }

  function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  async function buildStudentLookup(){
    const map = {};
    for(const sheet of studentLookupCandidates){
      const g = await fetchGviz(SHEET_ID_TOPPERS, sheet);
      if(!g || !g.table || !g.table.rows) continue;
      const cols = (g.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
      const rows = (g.table.rows||[]).map(r=> r.c || []);
      const admKey = cols.find(h=> admRegex.test(h)) || cols[0];
      const nameKey = cols.find(h=> nameRegex.test(h)) || cols.find(h=> /full\s*name|student|candidate/i.test(h)) || cols[1] || cols[0];
      const fatherKey = cols.find(h=> /father/i.test(h)) || null;
      const motherKey = cols.find(h=> /mother/i.test(h)) || null;
      const dobKey = cols.find(h=> /dob|date\s*of\s*birth|birth/i.test(h)) || null;
      const photoKey = cols.find(h=> /photo|image|pic|picture|photo url|image url/i.test(h)) || null;
      const classKey = cols.find(h=> classRegex.test(h)) || null;

      rows.forEach(cells=>{
        const obj = {};
        for(let i=0;i<cols.length;i++){
          const cell = cells[i];
          let v = '';
          if(cell){
            if(cell.v !== undefined) v = cell.v;
            else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
          }
          obj[cols[i]] = v;
        }
        const admRaw = String(obj[admKey]||'').trim();
        const adm = normAdm(admRaw);
        if(!adm) return;
        if(!map[adm]) map[adm] = {};
        map[adm].name = map[adm].name || (obj[nameKey] || '');
        map[adm].father = map[adm].father || (fatherKey ? (obj[fatherKey]||'') : '');
        map[adm].mother = map[adm].mother || (motherKey ? (obj[motherKey]||'') : '');
        map[adm].dob = map[adm].dob || (dobKey ? (obj[dobKey]||'') : '');
        map[adm].photo = map[adm].photo || (photoKey ? (obj[photoKey]||'') : '');
        map[adm].class = map[adm].class || (classKey ? (obj[classKey]||'') : '');
      });
    }
    return map;
  }

  async function collectToppersFromUnits(){
    const combinedByClass = {};
    for(const sheet of unitSheets){
      const g = await fetchGviz(SHEET_ID_TOPPERS, sheet);
      if(!g || !g.table || !g.table.rows || !g.table.rows.length) continue;
      const cols = (g.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
      const rows = (g.table.rows||[]).map(r=> r.c || []);
      const admKey = cols.find(h=> admRegex.test(h)) || cols[0];
      const classKey = cols.find(h=> classRegex.test(h)) || cols.find((_,i)=> i<3 && /class|std|grade/i.test(cols[i])) || cols[1] || cols[0];
      const scoreKey = cols.find(h=> scoreRegex.test(h)) || cols[cols.length-1];
      rows.forEach(cells=>{
        const obj = {};
        for(let i=0;i<cols.length;i++){
          const cell = cells[i];
          let v = '';
          if(cell){
            if(cell.v !== undefined) v = cell.v;
            else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
          }
          obj[cols[i]] = v;
        }
        const cls = String(obj[classKey] || 'Unknown').trim() || 'Unknown';
        const admRaw = String(obj[admKey] || '').trim();
        const adm = normAdm(admRaw);
        const scoreRaw = String(obj[scoreKey] || '').replace(/[^0-9.\-]/g,'').trim();
        const score = parseFloat(scoreRaw);
        if(!combinedByClass[cls]) combinedByClass[cls] = [];
        combinedByClass[cls].push({admRaw: admRaw, adm: adm, score: isNaN(score)? -Infinity : score, sheet: sheet, row: obj});
      });
    }
    const toppers = {};
    Object.keys(combinedByClass).forEach(cls=>{
      const arr = combinedByClass[cls].filter(x=> x.adm && x.adm.length>0);
      if(arr.length===0) return;
      const numeric = arr.filter(x=> x.score !== -Infinity);
      let top;
      if(numeric.length){
        numeric.sort((a,b)=> b.score - a.score);
        top = numeric[0];
      } else {
        top = arr[0];
      }
      toppers[cls] = top;
    });
    return toppers;
  }

  // UI refs
  const wrap = document.getElementById('topper3dWrap');
  const card = document.getElementById('topper3dCard');
  const closeBtn = document.getElementById('topper3dClose');
  const photoEl = document.getElementById('t3_photo');
  const titleEl = document.getElementById('t3_title');
  const nameEl = document.getElementById('t3_name');
  const classEl = document.getElementById('t3_class');
  const fatherEl = document.getElementById('t3_father');
  const motherEl = document.getElementById('t3_mother');
  const dobEl = document.getElementById('t3_dob');
  const admEl = document.getElementById('t3_adm');
  const scoreEl = document.getElementById('t3_score');
  const sheetEl = document.getElementById('t3_sheet');
  const intervalEl = document.getElementById('t3_interval');
  intervalEl.textContent = Math.round(REFRESH_MS/1000) + 's';

  let popupList = [];
  let idx = 0;
  let rotateTimer = null;
  let refreshTimer = null;

  function showItem(item){
    titleEl.innerHTML = `üéâ Topper ‚Äî Class ${escapeHtml(item.class)}`;
    nameEl.textContent = item.name || '‚Äî';
    classEl.textContent = item.class || '‚Äî';
    fatherEl.textContent = item.father || '‚Äî';
    motherEl.textContent = item.mother || '‚Äî';
    dobEl.textContent = item.dob || '‚Äî';
    admEl.textContent = item.adm || '‚Äî';
    scoreEl.textContent = (isFinite(item.score) ? item.score : item.score) || 'N/A';
    sheetEl.textContent = item.sheet || '‚Äî';
    if(item.photo && String(item.photo).trim().match(/^https?:\/\//i)){
      photoEl.innerHTML = `<img src="${escapeHtml(item.photo)}" alt="photo">`;
    } else {
      const initials = (item.name || '‚Äî').split(' ').filter(Boolean).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || '‚Äî';
      photoEl.innerHTML = `<div style="font-size:22px;color:#0b5fa8">${escapeHtml(initials)}</div>`;
    }
    wrap.style.display = 'block';
    const rx = (idx % 5) - 2;
    card.style.transform = `rotateX(${6+rx}deg) rotateY(${rx*1.6}deg) translateZ(10px)`;
  }

  function hideItem(){
    wrap.style.display = 'none';
  }

  function startRotation(){
    if(rotateTimer) clearTimeout(rotateTimer);
    if(!popupList || popupList.length===0){ hideItem(); return; }
    showItem(popupList[idx]);
    rotateTimer = setTimeout(()=>{
      idx = (idx + 1) % popupList.length;
      startRotation();
    }, SHOW_MS);
  }
  function stopRotation(){ if(rotateTimer) clearTimeout(rotateTimer); rotateTimer = null; }

  closeBtn.addEventListener('click', ()=> { stopRotation(); hideItem(); });
  card.addEventListener('mouseenter', ()=> stopRotation());
  card.addEventListener('mouseleave', ()=> startRotation());

  async function refreshAndStart(){
    stopRotation();
    const studentMap = await buildStudentLookup();
    const toppers = await collectToppersFromUnits();
    popupList = [];
    Object.keys(toppers).forEach(cls=>{
      const t = toppers[cls];
      if(!t || !t.adm) return;
      const admRaw = t.admRaw || t.adm;
      const admNorm = t.adm;
      const details = studentMap[admNorm] || {};
      const item = {
        class: cls,
        adm: admRaw || admNorm,
        name: details.name || (t.row && (t.row['Student Name']||t.row['Name']||t.row['student name']) ? (t.row['Student Name']||t.row['Name']||t.row['student name']) : '‚Äî'),
        father: details.father || '',
        mother: details.mother || '',
        dob: details.dob || '',
        photo: details.photo || '',
        score: t.score === -Infinity ? 'N/A' : t.score,
        sheet: t.sheet || ''
      };
      popupList.push(item);
    });
    popupList.sort((a,b)=> String(a.class).localeCompare(String(b.class), undefined, {numeric:true}));
    if(popupList.length===0){ hideItem(); }
    else { idx = 0; startRotation(); }
    if(refreshTimer) clearTimeout(refreshTimer);
    refreshTimer = setTimeout(refreshAndStart, REFRESH_MS);
  }

  try{ await refreshAndStart(); }catch(e){ console.error('Topper BIG script error', e); }

})();
</script>
<!-- ====== END TOPPERS 3D ====== -->

</body>
</html>
