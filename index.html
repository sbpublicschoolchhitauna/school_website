<!-- ===========================
     AI STUDENT ASSISTANT WIDGET
     Paste this before </body> in your index.html
     =========================== -->
<style>
/* Chat widget styles */
.ai-widget-btn {
  position: fixed;
  right: 18px;
  bottom: 18px;
  background: linear-gradient(90deg,#0b5fa8,#1167b1);
  color: #fff;
  border: 0;
  padding: 12px 16px;
  border-radius: 999px;
  box-shadow: 0 10px 30px rgba(2,6,23,0.18);
  cursor: pointer;
  z-index: 99999;
  font-weight:700;
}
.ai-widget-panel {
  position: fixed;
  right: 18px;
  bottom: 78px;
  width: 360px;
  max-width: calc(100% - 40px);
  height: 520px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 18px 60px rgba(2,6,23,0.22);
  z-index: 99998;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
}
.ai-widget-header{
  background: linear-gradient(90deg,#0b5fa8,#1167b1);
  color: #fff; padding:10px 12px; font-weight:800; display:flex; align-items:center; justify-content:space-between;
}
.ai-widget-body{flex:1; padding:12px; overflow:auto; background:linear-gradient(180deg,#f7fbff,#fff);}
.ai-msg{margin-bottom:10px; display:flex; gap:8px;}
.ai-msg .bubble{padding:8px 10px; border-radius:10px; max-width:82%;}
.ai-msg.user .bubble{margin-left:auto; background:#0b5fa8; color:#fff; border-bottom-right-radius:4px;}
.ai-msg.bot .bubble{background:#f1f7ff; color:#03314b; border-bottom-left-radius:4px;}
.ai-widget-input{display:flex; gap:8px; padding:10px; border-top:1px solid #eef6ff; background:#fff;}
.ai-widget-input input{flex:1;padding:10px;border:1px solid #dfefff;border-radius:8px;}
.ai-suggests{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.ai-suggest{background:#eef8ff;padding:6px 8px;border-radius:999px;border:1px solid #d6ecff;font-weight:700;cursor:pointer}
.ai-loading {font-size:13px;color:#666;margin-top:6px}
@media(max-width:420px){ .ai-widget-panel{right:10px; left:10px; width:auto; bottom:70px; height:60vh;} }
</style>

<button id="openAiWidget" class="ai-widget-btn" aria-expanded="false">AI सहायक</button>

<div id="aiWidgetPanel" class="ai-widget-panel" role="dialog" aria-hidden="true" style="display:none;">
  <div class="ai-widget-header">
    <div>StudyGenie — Student Assistant</div>
    <div style="font-size:12px;opacity:0.95">S.B. PUBLIC SCHOOL</div>
  </div>
  <div id="aiWidgetBody" class="ai-widget-body" aria-live="polite">
    <div class="ai-msg bot"><div class="bubble"><strong>नमस्ते!</strong> मैं आपकी मदद के लिये यहाँ हूँ — आप मुझसे पूछ सकते हैं: <em>"मेरे एडमिशन नंबर 3717158 की डिटेल दिखाओ"</em>, <em>"फीस स्टेटस"</em>, <em>"मार्कशीट दिखाओ"</em>, या <em>"admission timing"</em>.</div></div>

    <div class="ai-suggests" id="aiSuggests">
      <div class="ai-suggest" data-q="Student details for 3717158">Show Student (3717158)</div>
      <div class="ai-suggest" data-q="Open Fee Portal">Open Fee Portal</div>
      <div class="ai-suggest" data-q="How to apply for admission">Admission Info</div>
      <div class="ai-suggest" data-q="Show marks for class 10">Marksheet</div>
    </div>

    <div id="aiConversationEnd" style="margin-top:10px"></div>
  </div>

  <div class="ai-widget-input">
    <input id="aiInput" type="text" placeholder="Type your question in Hindi or English..." aria-label="AI input" />
    <button id="aiSendBtn" class="btn">Send</button>
  </div>
</div>

<script>
/* AI Widget behavior and rule-based intent handling.
   It tries to use existing portal functions (searchStudent, showTab, etc).
   Optional: If you deploy a server AI endpoint (/api/ai), the widget will call it for advanced replies.
*/

const openBtn = document.getElementById('openAiWidget');
const panel = document.getElementById('aiWidgetPanel');
const body = document.getElementById('aiWidgetBody');
const input = document.getElementById('aiInput');
const sendBtn = document.getElementById('aiSendBtn');
const suggests = document.getElementById('aiSuggests');

function appendMsg(role, html){
  const d = document.createElement('div');
  d.className = 'ai-msg ' + (role==='user' ? 'user' : 'bot');
  const b = document.createElement('div');
  b.className = 'bubble';
  b.innerHTML = html;
  d.appendChild(b);
  body.insertBefore(d, document.getElementById('aiConversationEnd'));
  body.scrollTop = body.scrollHeight;
}

// Open / close
openBtn.addEventListener('click', ()=>{
  const show = panel.style.display === 'none' || panel.style.display === '';
  panel.style.display = show ? 'flex' : 'none';
  panel.setAttribute('aria-hidden', show ? 'false' : 'true');
  openBtn.setAttribute('aria-expanded', show ? 'true' : 'false');
  if(show) input.focus();
});

// quick suggestions
document.querySelectorAll('.ai-suggest').forEach(el=>{
  el.addEventListener('click', ()=> {
    input.value = el.dataset.q || el.innerText;
    handleQuery(input.value);
  });
});

sendBtn.addEventListener('click', ()=> handleQuery(input.value));
input.addEventListener('keydown', (e)=> { if(e.key==='Enter'){ e.preventDefault(); handleQuery(input.value); } });

/* Intent parsing (simple, keyword-based).
   You can extend this with more sophisticated NLP or plug a server AI.
*/
async function handleQuery(text){
  text = (text||'').trim();
  if(!text) return;
  appendMsg('user', escapeHtml(text));
  input.value = '';
  // show loading
  appendMsg('bot', '<span class="ai-loading">Processing…</span>');

  // simple keyword-intent matching
  const q = text.toLowerCase();

  // 1. direct "open portal" requests
  if(/fee|fee portal|pay fee|payment/i.test(q)){
    removeLastLoading();
    appendMsg('bot', 'फीस पोर्टल खोल रहा/रही हूँ — नया टैब खुल जाएगा।');
    window.open('https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec', '_blank');
    return;
  }
  if(/marks|marksheet|mark/i.test(q) || /result/i.test(q)){
    removeLastLoading();
    // switch tab to marks in the page (if function exists)
    try{ showTab('marks'); appendMsg('bot', 'Marksheet सेक्शन दिखा रहा/रही हूँ — नीचे स्क्रोल कर देखें.'); }catch(e){ appendMsg('bot','Marksheet सेक्शन खोलने में दिक्कत: '+escapeHtml(String(e))); }
    return;
  }

  // 2. student lookup by admission number: detect numbers
  const admMatch = q.match(/(\b\d{4,8}\b)/);
  if(/\badmission|admit|admission number|adm\b|adm\.?/i.test(q) && admMatch){
    const adm = admMatch[1];
    removeLastLoading();
    appendMsg('bot', 'आपके दिए एडमिशन नंबर के अनुसार विवरण खोज रहा/रही हूँ — परिणाम नीचे दिखेंगे।');
    // fill the admission input and call existing searchStudent
    try{
      document.getElementById('admission').value = adm;
      await searchStudent(); // relies on existing function in page
      appendMsg('bot','यदि विवरण नहीं दिखे तो Google Sheet sharing और Admission number चेक करें।');
    }catch(e){
      appendMsg('bot','Search चलाने में समस्या: '+escapeHtml(String(e)));
    }
    return;
  }

  // 3. admission info / timings / docs
  if(/admission|apply|how to apply|documents/i.test(q)){
    removeLastLoading();
    appendMsg('bot', `<strong>Admission Info:</strong><br>
      • टाइमिंग: 8:30 AM – 3:00 PM.<br>
      • डॉक्यूमेंट: जन्म प्रमाण-पत्र, (आधार यदि हो).<br>
      • संपर्क: Principal — Mr. Gajendra Yadav · +91 6389259200.<br><br>
      आप चाहें तो मैं Admission news बार में दिख रहे ম্যसेज भी अपडेट कर सकता/सकती हूँ (यदि आप new messages भेजें)।`);
    return;
  }

  // 4. show quick notifications
  if(/notification|news|what's new|latest/i.test(q)){
    removeLastLoading();
    try{ const notifs = document.querySelectorAll('#notifs .notify-item'); if(notifs.length){
        appendMsg('bot', 'हाल की सूचनाएँ--- नीचे Notifications सेक्शन देखें।');
        showPanelTabIfNeeded(); // optional helper
      } else appendMsg('bot','किसी notification sheet में अभी कोई एंट्री नहीं है।');
    }catch(e){ appendMsg('bot','Notification पढने में समस्या: '+escapeHtml(String(e))); }
    return;
  }

  // 5. fallback: call server AI if available, else simple canned reply
  try{
    const aiResponse = await callServerAIIfAvailable(text);
    removeLastLoading();
    if(aiResponse && aiResponse.reply){
      appendMsg('bot', escapeHtml(aiResponse.reply).replace(/\n/g,'<br>'));
    } else {
      appendMsg('bot', 'क्षमा करें — मैं अभी इस प्रश्न का पूरा उत्तर देने में सक्षम नहीं हूँ। आप चाहें तो "summarize:" लिखकर किसी पाठ का संक्षेप निकलवा सकते हैं।');
    }
  }catch(err){
    removeLastLoading();
    // fallback simple reply
    appendMsg('bot', 'माफ़ करें, सर्वर-AI उपलब्ध नहीं — यहाँ कुछ सुझाव दिए जा रहे हैं:<br>• "Show Student 3717158"<br>• "Open Fee Portal"<br>• "How to apply for admission"');
  }
}

// small helpers
function removeLastLoading(){
  const loads = body.querySelectorAll('.ai-loading');
  loads.forEach(l => l.parentElement && l.parentElement.parentElement && l.parentElement.parentElement.remove());
  body.scrollTop = body.scrollHeight;
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Optional: open panel's tab or scroll to section
function showPanelTabIfNeeded(){
  try{
    document.getElementById('notifyOuter').scrollIntoView({behavior:'smooth'});
  }catch(e){}
}

/* Optional server integration:
   If you host a server endpoint at /api/ai that accepts {query: "..."} and returns {reply: "..."},
   the widget will call it. Otherwise it will skip server and use fallback replies.

   Example server response expected JSON:
     { "reply": "Here is the answer..." }

   SECURITY: Don't embed API keys in client-side code. If you want to integrate OpenAI,
   create a server (Node/Express / Python Flask) that holds the API key and proxies requests.
*/
async function callServerAIIfAvailable(q){
  // attempt to call server endpoint (non-blocking fallback)
  try{
    const res = await fetch('/api/ai', {
      method:'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ query: q })
    });
    if(!res.ok) throw new Error('no server ai');
    const j = await res.json();
    return j;
  }catch(e){
    throw e;
  }
}
</script>
<!-- ===========================
     END AI STUDENT ASSISTANT WIDGET
     =========================== -->
