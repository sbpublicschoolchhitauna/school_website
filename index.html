<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School — Student Portal (Tabs)</title>
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial, sans-serif;background:linear-gradient(180deg,#eaf4ff,#f7fbff);color:#0f172a}
.container{max-width:1100px;margin:14px auto;padding:12px}
.header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  padding:18px 14px;
  text-align:center;
  color:#fff;
  border-radius:12px;
  box-shadow:0 8px 22px rgba(0,0,0,0.12);
}
.header h1{margin:0;font-size:20px}
.header .sub{margin-top:6px;font-size:13px;opacity:0.95}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:600px}
th,td{padding:8px 10px;border-bottom:1px solid #f1f7ff;text-align:left;vertical-align:middle}
thead th{background:#f5fbff;color:var(--accent);position:sticky;top:0;z-index:1}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.search-row{display:flex;gap:8px;margin-bottom:8px}
@media(max-width:640px){table{font-size:12px;min-width:520px}}
</style>
</head>
<body>
<div class="container">
  <div class="header" id="schoolHeader">
    <h1 id="schoolName">S.B. PUBLIC SCHOOL CHHITAUNA</h1>
    <div class="sub" id="schoolMeta">POST MEGHAULI KALA — PIN 273305 · PRINCIPAL: MR. GAJENDRA YADAV</div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h2>Student Details Lookup</h2>
        <div class="small">Admission Number डालकर Search करें</div>
        <div style="margin-top:8px" class="search-row">
          <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
          <button class="btn" onclick="searchStudent()">Search</button>
        </div>
        <div id="result"></div>
      </div>

      <!-- Single card containing both Fee and Marksheet with tabs -->
      <div class="card">
        <h2>Student Records</h2>
        <div class="small">नीचे टैब बदल कर Fee या Marksheet देखें — Mobile/Aadhar masked (last 4)</div>

        <div class="tabbar" role="tablist">
          <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee Student Details</button>
          <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet Details</button>
        </div>

        <div id="feeContainer" class="table-wrap" style="display:block">लोड हो रहा है...</div>
        <div id="marksContainer" class="table-wrap" style="display:none; margin-top:10px">लोड हो रहा है...</div>
      </div>

    </div>

    <div>
      <div class="card">
        <h2>Notifications</h2>
        <div id="notifyWrap" style="height:220px;overflow:hidden;position:relative">
          <div id="notifs" style="position:absolute;left:0;right:0;top:0"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>Quick Portals</h2>
        <div style="margin-top:8px">
          <a class="btn" href="https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec" target="_blank">Fee Portal</a>
          <a class="btn" href="https://script.google.com/macros/s/AKfycbzmAK3rf7ah-4BDi5BEcZeu859kPWAthpPFgsMiCbM2Gp-Do0yuS7QpzucWRssZMwqLtA/exec" target="_blank" style="margin-left:8px">Marksheet</a>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">© <span id="year"></span> S.B. PUBLIC SCHOOL — All Rights Reserved</div>
</div>

<script>
const SHEET_ID = "1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8";

/* Utils */
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
async function loadSheetGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const text = await res.text();
  const jsonText = text.replace(/^[^{]*/,'').replace(/\);\s*$/,'');
  return JSON.parse(jsonText);
}

/* Mask */
function maskLast4(val){
  if(val===null||val===undefined) return "";
  const s = String(val).trim();
  const digits = s.replace(/\D/g,'');
  if(digits.length === 0) return '';
  const last4 = digits.slice(-4);
  return '****' + last4;
}
function isMobileHeader(h){ return /mobile|phone|contact|mob/i.test(h); }
function isAadharHeader(h){ return /aadhar|aadhaar|uid/i.test(h); }

/* Render table keeping all columns */
function renderTableTo(containerId, gvizJson){
  const cols = (gvizJson.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
  const rows = (gvizJson.table.rows||[]).map(r=> r.c || []);
  const wrap = document.getElementById(containerId);
  if(rows.length === 0){ wrap.innerHTML = "<div style='padding:12px;color:#666'>कोई रिकॉर्ड नहीं मिला।</div>"; return; }

  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(h=>{
    const th = document.createElement('th');
    th.innerText = h || '';
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    for(let i=0;i<cols.length;i++){
      const cell = r[i];
      let v = "";
      if(cell){
        if(cell.f !== undefined && String(cell.f).trim()!=='') v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        else if(cell.v !== undefined) v = cell.v;
      }
      const header = cols[i]||'';
      if(isMobileHeader(header)) v = maskLast4(v);
      if(isAadharHeader(header)) v = maskLast4(v);
      const td = document.createElement('td');
      td.innerText = v;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML = "";
  wrap.appendChild(table);
}

/* Tabs */
function showTab(name){
  document.getElementById('feeContainer').style.display = name==='fee' ? 'block' : 'none';
  document.getElementById('marksContainer').style.display = name==='marks' ? 'block' : 'none';
  document.getElementById('tabFee').classList.toggle('active', name==='fee');
  document.getElementById('tabMarks').classList.toggle('active', name==='marks');
}

/* Loaders */
async function loadNotifications(){
  try{
    const data = await loadSheetGviz("Notification");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message/i.test(k)) || cols[1] || cols[0] || 'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k)) || cols[0] || 'Date';
    const wrap = document.getElementById("notifs");
    wrap.innerHTML = "";
    rows.forEach(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]] = v;
      }
      const d = obj[dateKey] || '';
      const t = obj[textKey] || '';
      const node = document.createElement('div');
      node.style.padding = '8px';
      node.style.borderBottom = '1px solid #f1f7ff';
      node.innerHTML = `<div style="font-weight:700;color:#0b5fa8">${escapeHtml(d)}</div><div style="margin-top:4px">${escapeHtml(t)}</div>`;
      wrap.appendChild(node);
    });
  }catch(err){
    console.error(err);
    document.getElementById("notifs").innerHTML = "<div style='padding:12px;color:#c33'>Notification लोड नहीं हुए — sheet नाम और sharing चेक करें।</div>";
  }
}

async function loadFeeAndMarks(){
  try{
    const feeJson = await loadSheetGviz("Fee Student Details");
    renderTableTo("feeContainer", feeJson);
  }catch(e){
    console.error(e);
    document.getElementById("feeContainer").innerHTML = "<div style='padding:12px;color:#c33'>Fee Student Details लोड नहीं हुए — sheet नाम और sharing चेक करें।</div>";
  }
  try{
    const marksJson = await loadSheetGviz("Marksheet Details");
    renderTableTo("marksContainer", marksJson);
  }catch(e){
    console.error(e);
    document.getElementById("marksContainer").innerHTML = "<div style='padding:12px;color:#c33'>Marksheet Details लोड नहीं हुए — sheet नाम और sharing चेक करें।</div>";
  }
}

/* Search uses Student's Details if present */
async function searchStudent(){
  const adm = document.getElementById("admission").value.trim();
  if(!adm) return alert("Admission Number डालें");
  try{
    const data = await loadSheetGviz("Student's Details");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]||('col'+i)] = v;
      }
      return obj;
    });

    const admKeys = ["Admission No.","Adm. No.","Admission Number","Adm No","Admission No"];
    const rec = records.find(r => admKeys.some(k=> String(r[k]) === adm || String(r[k]) === ("0"+adm)));
    const out = document.getElementById("result");
    out.style.display = 'block';
    if(!rec){
      out.innerHTML = "<div style='padding:12px;background:#fff;border-radius:8px;border:1px solid #f1f7ff'>No details found for this Admission Number.</div>";
      return;
    }

    const fields = ["Student Name","Father Name","Mother Name","Date of Birth","Class","Address"];
    let html = '<div style="padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ff">';
    fields.forEach(f=>{
      html += `<div style="margin-bottom:8px"><strong>${f}:</strong> ${escapeHtml(rec[f]||'')}</div>`;
    });
    html += '</div>';
    out.innerHTML = html;

  }catch(e){
    console.error("Search error", e);
    alert("Search में समस्या — console देखें।");
  }
}

/* Make header responsive: adjust school name / meta based on width */
function adjustHeader(){
  const w = window.innerWidth;
  const name = document.getElementById('schoolName');
  const meta = document.getElementById('schoolMeta');
  if(w < 420){
    name.style.fontSize = '16px';
    meta.style.display = 'block';
    meta.style.fontSize = '12px';
  } else if(w < 700){
    name.style.fontSize = '18px';
    meta.style.fontSize = '13px';
    meta.style.display = 'block';
  } else {
    name.style.fontSize = '20px';
    meta.style.fontSize = '13px';
    meta.style.display = 'block';
  }
}

/* Init */
document.getElementById("year").innerText = new Date().getFullYear();
window.addEventListener('resize', adjustHeader);
adjustHeader();
loadNotifications();
loadFeeAndMarks();
</script>
</body>
</html>
