<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.B. Public School Chhitauna ‚Äî Student Portal</title>
<style>
:root{--accent:#0b5fa8;--accent2:#1167b1;--card:#fff;--muted:#54607a}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Segoe UI,Roboto,sans-serif;color:#0f172a;background:linear-gradient(180deg,#eaf4ff,#f7fbff)}
/* Centered header */
.header{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  color:#fff;text-align:center;padding:18px 12px;border-radius:0 0 14px 14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.12); position:sticky; top:0; z-index:9999;
}
.header h1{margin:0;font-size:clamp(20px,4.5vw,30px);font-weight:800;letter-spacing:0.4px}
.header .meta{margin-top:6px;font-size:14px;opacity:0.95}
.header .meta small{display:block;font-size:13px;opacity:0.9;margin-top:4px}

/* horizontal strip under header */
.school-strip-outer{overflow:hidden;width:100%;margin-top:12px;padding-bottom:8px}
.school-strip{white-space:nowrap;display:flex;gap:18px;align-items:center;will-change:transform;transform:translateX(0)}
.school-chip{display:inline-block;font-weight:700;font-size:14px;background:rgba(255,255,255,0.06);padding:6px 12px;border-radius:8px}

/* main layout */
.container{max-width:1100px;margin:14px auto;padding:12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:12px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 5px 18px rgba(0,0,0,0.06);margin-bottom:12px}
h2{margin:0;color:var(--accent);font-size:16px;margin-bottom:8px}
.small{color:var(--muted);font-size:13px}
.tabbar{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:8px;background:#f1fbff;border:1px solid #d6ecff;color:var(--accent);cursor:pointer;font-weight:600}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:0}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:8px 12px;border:0;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
.search-row{display:flex;gap:8px;margin-bottom:8px}
@media(max-width:640px){.search-row{flex-direction:column} .tabbar{gap:6px}}

/* tables */
.table-wrap{overflow:auto;border-radius:8px;border:1px solid #eef6ff;padding:6px;background:#fff;max-height:360px}
@media(max-width:900px){.table-wrap{max-height:300px}}
table{width:100%;border-collapse:collapse;font-size:13px;min-width:720px}
th,td{padding:8px 10px;border-bottom:1px solid #f1f7ff;text-align:left;vertical-align:middle}
thead th{background:#f5fbff;color:var(--accent);position:sticky;top:0;z-index:1}

/* notifications */
.notify-wrap{height:220px;overflow:hidden;position:relative;border-radius:8px}
.notify-list{position:absolute;left:0;right:0;top:0;will-change:transform}
.notify-item{padding:10px 12px;border-bottom:1px solid #eef4ff;background:#fff}
.notify-item .date{font-size:12px;color:var(--accent);font-weight:700}
.notify-item .text{font-size:14px;margin-top:4px}

/* footer */
.footer{ text-align:center;margin-top:12px;color:#555;font-size:13px}
</style>

<style id="assistant-button-fix">
/* Make Quick Portals and Search buttons clearly visible */
a.btn[data-portal="true"], button.btn[data-portal="true"], button.btn.search-btn {
  background: #000 !important;
  color: #fff !important;
  border: 1px solid #000 !important;
  box-shadow: none !important;
}
/* Ensure slider controls remain light */
.slider-wrap .btn { background: rgba(255,255,255,0.9); color: #000; }
</style>

</head>
<body>

  <!-- CENTERED HEADER -->
  <div class="header" role="banner" aria-label="School header">
    <h1>S.B. PUBLIC SCHOOL</h1>
    <div class="meta">
      Village Chhitauna ¬∑ Post Meghauli Kala ¬∑ Pin Code 273304
      <small>Principal ‚Äî Mr. Gajendra Yadav Sir ¬∑ Call: +91 6389259200 ¬∑ Created By ‚Äî Upendra Vishwakarma</small>
    </div>

    <!-- horizontal strip populated from Notification sheet -->
    <div class="school-strip-outer" id="schoolStripOuter" aria-live="polite">
      <div id="schoolStrip" class="school-strip"></div>
    </div>
  </div>

  <!-- ====== ADMISSION TICKER (premium, eye-friendly gradient, multiple rotating messages) ====== -->
  <style>
  /* Eye-friendly soft blue-cyan gradient, subtle 3D */
  .admission-news-bar{
    width:100%;
    background:linear-gradient(90deg,#9be7ff,#c7f9ff);
    color:#03314b;
    padding:12px 0;
    font-weight:800;
    font-size:16px;
    overflow:hidden;
    position:relative;
    border-radius:10px;
    margin:14px auto;
    max-width:1100px;
    box-shadow:0 10px 26px rgba(3,19,43,0.10), inset 0 -4px 14px rgba(0,0,0,0.03);
    transform:translateZ(0);
    perspective:800px;
  }
  .admission-news-inner{
    position:relative;
    transform-origin:center;
    transform: translateZ(0) rotateX(0.3deg);
    max-width:calc(100% - 28px);
    margin:0 14px;
  }
  .admission-news-text{
    display:inline-block;
    white-space:nowrap;
    padding-left:1rem;
    will-change:transform,opacity;
    color:#012032;
    font-weight:800;
  }
  .admission-news-ghost{
    position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:0.06;
    background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,0.6) 50%,transparent 100%);
  }
  .admission-news-meta{
    display:flex;align-items:center;gap:12px;overflow:hidden;padding:0 4px;
  }
  .admission-tag{
    background:rgba(1,48,62,0.06);padding:6px 10px;border-radius:999px;font-weight:900;font-size:13px;border:1px solid rgba(1,48,62,0.04);color:#012032;
  }
  @media(max-width:640px){ .admission-news-bar{font-size:14px;padding:10px 0} .admission-tag{display:none} }
  </style>

  <div class="admission-news-bar" role="region" aria-label="Admission news ticker" tabindex="0" id="admissionTickerWrap">
    <div class="admission-news-inner">
      <div class="admission-news-meta">
        <div class="admission-tag">üì¢ ADMISSION</div>
        <div class="admission-news-text" id="admissionNewsText" aria-live="polite"></div>
      </div>
      <div class="admission-news-ghost" aria-hidden="true"></div>
    </div>
  </div>

  <!-- START: Inserted Photo Slider (existing slider code kept as-is) -->
  <!doctype html>
  <html lang="hi">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SB Public School ‚Äî Photo Slider (Fade, Auto-height)</title>
  <style>
  :root{--accent:#0ea5a4;--bg:#fbfdff;--text:#0f1724}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .slider-wrap{max-width:1100px;margin:20px auto;position:relative;border-radius:12px;overflow:visible}
  .slider{position:relative;border-radius:12px;overflow:hidden;box-shadow:0 8px 30px rgba(16,24,40,0.08);background:#000;transition:height .45s ease}
  .slide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .8s ease;will-change:opacity;pointer-events:none}
  .slide.active{opacity:1;pointer-events:auto}
  .slide img{width:100%;height:auto;display:block;object-fit:cover}
  /* controls */
  .controls{position:absolute;left:12px;right:12px;top:50%;transform:translateY(-50%);display:flex;justify-content:space-between;pointer-events:none}
  .slider-wrap .btn{background:rgba(255,255,255,0.9);border:0;padding:10px;border-radius:999px;cursor:pointer;pointer-events:auto;box-shadow:0 6px 18px rgba(2,6,23,0.12)}
  .dots{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;display:flex;gap:8px;pointer-events:auto}
  .dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.8);cursor:pointer;opacity:0.8}
  .dot.active{background:var(--accent);transform:scale(1.2);opacity:1}
  .slider-wrap .play-toggle{position:absolute;right:16px;top:16px;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px;border:0;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
  @media(max-width:600px){ .slider-wrap{margin:12px} .btn{padding:8px} }
  </style>
  <style id="assistant-button-fix">
  a.btn[data-portal="true"], button.btn[data-portal="true"], button.btn.search-btn {
    background: #000 !important;
    color: #fff !important;
    border: 1px solid #000 !important;
    box-shadow: none !important;
  }
  .slider-wrap .btn { background: rgba(255,255,255,0.9); color: #000; }
  </style>
  </head>
  <body>
  <div class="slider-wrap" id="sliderWrap" aria-label="School photo slider (fade)">
    <button class="play-toggle" id="playToggle" aria-pressed="false">Pause</button>
    <div class="slider" id="slider" role="region" aria-roledescription="carousel"></div>
    <div class="controls">
      <button class="btn slider-control" id="prev" aria-label="Previous">‚Äπ</button>
      <button class="btn slider-control" id="next" aria-label="Next">‚Ä∫</button>
    </div>
    <div class="dots" id="dots" role="tablist" aria-label="Slide dots"></div>
  </div>

  <script>
  // IMAGES will be loaded dynamically: try /api/images (server), then images.json (static), then fallback to embedded list
  async function loadImagesDynamic(){
    try{ const res = await fetch('/api/images'); if(res.ok){ const j = await res.json(); if(Array.isArray(j.images) && j.images.length) return j.images; } }catch(e){}
    try{ const res2 = await fetch('images.json'); if(res2.ok){ const j2 = await res2.json(); if(Array.isArray(j2.images) && j2.images.length) return j2.images; } }catch(e){}
    return [
      'slider_images/WhatsApp Image 2025-11-16 at 10.33.37_c4bd2e68.jpg',
      'slider_images/WhatsApp Image 2025-10-30 at 19.36.04_e42049db.jpg',
      'slider_images/WhatsApp Image 2025-11-16 at 10.33.39_5f42559c.jpg',
      'slider_images/WhatsApp Image 2025-11-16 at 10.33.38_3193ced1.jpg',
      'slider_images/WhatsApp Image 2025-10-30 at 19.35.04_d1684284.jpg',
      'slider_images/WhatsApp Image 2025-10-30 at 19.36.05_6d3a2a2d.jpg',
      'slider_images/WhatsApp Image 2025-10-30 at 19.36.04_66cb599d.jpg',
      'slider_images/WhatsApp Image 2025-11-16 at 10.33.48_b61cc87d.jpg',
      'slider_images/WhatsApp Image 2025-11-16 at 10.33.47_3953b4e7.jpg',
      'slider_images/WhatsApp Image 2024-09-09 at 11.13.17_4b384d82.jpg',
      'slider_images/WhatsApp Image 2024-09-09 at 11.13.16_040cf6d0.jpg',
      'slider_images/logo.jpg',
    ];
  }

  let IMAGES = []; // will be populated shortly

  (async function(){
    IMAGES = await loadImagesDynamic();
    if(typeof createSlides === 'function') createSlides();
    if(typeof start === 'function') start();
  })();

  const slider = document.getElementById('slider');
  const sliderWrap = document.getElementById('sliderWrap');
  const dotsWrap = document.getElementById('dots');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const playToggle = document.getElementById('playToggle');

  let slides = [];
  let index = 0;
  let timer = null;
  let interval = 4000; // autoplay interval

  function createSlides(){
    IMAGES.forEach((src,i)=>{
      const s = document.createElement('div');
      s.className = 'slide';
      s.setAttribute('role','group');
      s.setAttribute('aria-roledescription','slide');
      s.setAttribute('aria-label', `Slide ${i+1} of ${IMAGES.length}`);
      const img = document.createElement('img');
      img.src = src;
      img.alt = `School photo ${i+1}`;
      img.addEventListener('load', ()=>{
        if(i===index) adjustHeightTo(img);
      });
      s.appendChild(img);
      slider.appendChild(s);
      slides.push(s);

      const d = document.createElement('button');
      d.className = 'dot';
      d.setAttribute('aria-label', 'Go to slide ' + (i+1));
      d.addEventListener('click', ()=>{ pause(); goTo(i); });
      dotsWrap.appendChild(d);
    });
    if(slides[0]) slides[0].classList.add('active');
    updateDots();
    setTimeout(()=>{ const img = slides[0].querySelector('img'); if(img && img.complete) adjustHeightTo(img); }, 300);
  }

  function adjustHeightTo(img){
    const wrapWidth = slider.clientWidth || sliderWrap.clientWidth;
    if(!img.naturalWidth) return;
    const h = Math.round((img.naturalHeight / img.naturalWidth) * wrapWidth);
    const maxH = Math.round(window.innerHeight * 0.65);
    const finalH = Math.min(h, maxH);
    slider.style.height = finalH + 'px';
  }

  function goTo(i){
    index = (i + slides.length) % slides.length;
    slides.forEach((s, idx)=> s.classList.toggle('active', idx===index));
    updateDots();
    const img = slides[index].querySelector('img');
    if(img && img.complete) adjustHeightTo(img);
    else if(img) img.addEventListener('load', ()=> adjustHeightTo(img), { once:true });
  }

  function nextSlide(){ goTo(index+1); }
  function prevSlide(){ goTo(index-1); }

  function updateDots(){
    const dots = dotsWrap.children;
    for(let i=0;i<dots.length;i++){ dots[i].classList.toggle('active', i===index); }
  }

  function start(){ if(timer) clearInterval(timer); timer = setInterval(nextSlide, interval); playToggle.textContent = 'Pause'; playToggle.setAttribute('aria-pressed','false'); }
  function pause(){ if(timer) clearInterval(timer); timer = null; playToggle.textContent = 'Play'; playToggle.setAttribute('aria-pressed','true'); }

  nextBtn.addEventListener('click', ()=>{ pause(); nextSlide(); });
  prevBtn.addEventListener('click', ()=>{ pause(); prevSlide(); });
  playToggle.addEventListener('click', ()=>{ if(timer) pause(); else start(); });

  document.addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ pause(); nextSlide(); } else if(e.key==='ArrowLeft'){ pause(); prevSlide(); } });

  let startX=0;
  slider.addEventListener('touchstart', e=> startX = e.touches[0].clientX);
  slider.addEventListener('touchend', e=> { const dx = e.changedTouches[0].clientX - startX; if(Math.abs(dx)>40){ pause(); if(dx<0) nextSlide(); else prevSlide(); } });

  let resizeDeb;
  window.addEventListener('resize', ()=>{ clearTimeout(resizeDeb); resizeDeb = setTimeout(()=>{ const img = slides[index] && slides[index].querySelector('img'); if(img && img.complete) adjustHeightTo(img); }, 120); });

  createSlides();
  start();
  </script>
  </body>
  </html>
  <!-- END: Inserted Photo Slider -->

<div class="container">
    <div class="grid">
      <div>

        <!-- QUICK PORTALS moved to TOP -->
        <div class="card">
          <h2>Quick Portals</h2>
          <div style="margin-top:8px">
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbySz9lSW1cwCcBWtAKOzknP6yWyawhgrETP-1EYaZ4-K8V-41Lg1GjdpLW0zA8sHX-G/exec" target="_blank">Fee Portal</a>
            <a class="btn" data-portal="true" href="https://script.google.com/macros/s/AKfycbzmAK3rf7ah-4BDi5BEcZeu859kPWAthpPFgsMiCbM2Gp-Do0yuS7QpzucWRssZMwqLtA/exec" target="_blank" style="margin-left:8px">Marksheet</a>
          </div>
        </div>



<!-- START: Birthday Auto-Wisher (from Student's Details sheet only) -->
<style>
.bday-card { background: linear-gradient(180deg,#fffdf6,#fff8ff); border-radius:12px; padding:12px; box-shadow:0 8px 24px rgba(10,20,40,0.06); margin-bottom:12px; position:relative; overflow:visible; }
.bday-banner { display:flex; gap:12px; align-items:center; padding:10px 12px; border-radius:10px; background:linear-gradient(90deg,#fff3f8,#f7fffb); box-shadow:0 8px 18px rgba(30,40,80,0.06); font-weight:800; color:#6b2140; }
.bday-list { margin-top:8px; font-size:14px; color:#0b2140; }
.confetti { pointer-events:none; position:absolute; inset:0; overflow:hidden; z-index:6; }
.confetti .piece{ position:absolute; width:10px;height:14px;opacity:0.95;border-radius:2px; transform-origin:center; animation: fall linear forwards; }
@keyframes fall { from { transform: translateY(-10vh) rotate(0deg); opacity:1; } to { transform: translateY(110vh) rotate(720deg); opacity:0.95; } }
.balloon-wrap { position:absolute; inset:0; pointer-events:none; z-index:5; overflow:visible; }
.balloon { position:absolute; bottom:-30px; width:36px; height:48px; border-radius:18px 18px 16px 16px / 22px 22px 18px 18px; opacity:0.97; transform-origin:center; animation: rise linear forwards; }
.balloon:after{ content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-10px; width:2px; height:22px; background:rgba(0,0,0,0.08); border-radius:2px; }
@keyframes rise { from { transform: translateY(0) scale(0.98) rotate(0deg); opacity:1; } to { transform: translateY(-120vh) scale(1) rotate(20deg); opacity:0.98; } }
.small-note { font-size:12px; color:#475569; margin-top:8px; }
</style>

<div class="card bday-card" id="birthdayCard">
  <div id="birthdayBannerContainer" style="display:none;"></div>
  <div id="birthdayListContainer" class="bday-list">‡§≤‡•á‡§ü‡•á‡§∏‡•ç‡§ü ‡§ö‡•á‡§ï ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à...</div>
  <div class="confetti" id="confettiArea"></div>
  <div class="balloon-wrap" id="balloonArea"></div>
  <div class="small-note">‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§ï‡§ø Google Sheet "Student's Details" public (Anyone with the link can view) ‡§π‡•à ‡§§‡§æ‡§ï‡§ø ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§∏‡•Ä‡§ß‡•á ‡§°‡•á‡§ü‡§æ ‡§™‡§¢‡§º ‡§∏‡§ï‡•á‡•§</div>

<!-- START: Additional Birthday Features -->
<style>
/* Small UI for upcoming list and class calendar */
.bday-features { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
.feature-card { background:#fff; border-radius:10px; padding:10px; box-shadow:0 6px 18px rgba(10,20,40,0.06); flex:1; min-width:260px; }
.feature-card h3 { margin:0 0 8px 0; font-size:15px; color:#0b5fa8; }
.upcoming-list li { margin-bottom:6px; }
.class-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:8px; margin-top:8px; }
.class-box { background:linear-gradient(90deg,#fff,#f7fbff); padding:8px; border-radius:8px; border:1px solid #eef7ff; min-height:60px; }
.print-btn { padding:8px 10px; border-radius:8px; border:0; background:linear-gradient(90deg,#0b5fa8,#1167b1); color:#fff; cursor:pointer; font-weight:700; }
.name-link { color:#0b5fa8; font-weight:700; cursor:pointer; text-decoration:underline; }
.modal-backdrop { position:fixed; inset:0; background:rgba(5,10,20,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal { background:#fff; border-radius:12px; padding:18px; max-width:520px; width:94%; box-shadow:0 20px 60px rgba(2,6,23,0.3); }
.certificate { width:700px; max-width:92vw; padding:28px; border-radius:12px; text-align:center; background:linear-gradient(180deg,#fff,#fffaf6); border:6px solid #ffd86b; }
.certificate h1 { margin:6px 0 12px 0; font-size:28px; color:#6b2140; }
.certificate p { margin:6px 0; color:#24304a; font-size:16px; }
@media(max-width:640px){ .bday-features{ flex-direction:column } .class-grid{ grid-template-columns:1fr } }
</style>

<div class="bday-features" id="bdayFeaturesArea" aria-live="polite" style="display:none;">
  <div class="feature-card" id="upcomingCard">
    <h3>üìÖ Upcoming Birthdays (7 days)</h3>
    <ul class="upcoming-list" id="upcomingList"><li>Loading...</li></ul>
    <div style="margin-top:8px"><button class="print-btn" id="printUpcoming">Print Upcoming</button></div>
  </div>

  <div class="feature-card" id="classCalendarCard">
    <h3>üåü Class-wise Birthday Calendar</h3>
    <div class="class-grid" id="classGrid">Loading...</div>
  </div>
</div>

<!-- Modal for Birthday Popup Card -->
<div class="modal-backdrop" id="bdayModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" id="bdayModalContent">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong id="modalTitle">Happy Birthday</strong>
      <button id="modalClose" title="Close" style="background:#fff;border:1px solid #e6eefc;padding:6px;border-radius:8px;cursor:pointer">‚úï</button>
    </div>
    <div id="modalBody" style="margin-top:12px;">
      <!-- filled dynamically -->
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button class="print-btn" id="modalPrint">üñ®Ô∏è Print Certificate</button>
    </div>
  </div>
</div>

<script>
// Utility: open modal with student details
function openBirthdayModal(student){
  const modal = document.getElementById('bdayModal');
  const body = document.getElementById('modalBody');
  const title = document.getElementById('modalTitle');
  title.innerText = student.name + " ‚Äî ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§¨‡§ß‡§æ‡§à!";
  body.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      <div style="width:96px;height:96px;border-radius:12px;background:linear-gradient(180deg,#fff,#ffe9c4);display:flex;align-items:center;justify-content:center;font-weight:900;font-size:34px;color:#6b2140">${(student.name||'')[0]||''}</div>
      <div style="flex:1">
        <div style="font-size:18px;font-weight:800;color:#0b5fa8">${student.name||'‚Äî'}</div>
        <div style="color:#475569;margin-top:6px">Class: ${student.class||'‚Äî'} ¬∑ Adm: ${student.adm||'‚Äî'}</div>
        <div style="color:#475569;margin-top:6px">Parents: ${student.father||''}${student.mother?(' / ' + student.mother):''}</div>
      </div>
    </div>
    <div style="margin-top:12px;color:#24304a">Address: ${student.address||'‚Äî'}</div>
  `;
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');

  // attach print handler for this student
  const printBtn = document.getElementById('modalPrint');
  printBtn.onclick = function(){ generateCertificate(student); };
}

// close modal
document.getElementById('modalClose').addEventListener('click', ()=>{
  const modal = document.getElementById('bdayModal');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
});

// Print/generate certificate (opens new window and calls print)
function generateCertificate(student){
  const win = window.open('', '_blank', 'width=800,height=800');
  const html = `
  <html><head><title>Certificate - ${student.name||''}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f6ff;padding:20px}
    .cert{max-width:720px;margin:30px auto;background:#fff;padding:28px;border-radius:12px;border:6px solid #ffd86b;text-align:center}
    h1{color:#6b2140;margin-bottom:6px}
    p{color:#24304a}
    .small{font-size:13px;color:#475569;margin-top:12px}
  </style>
  </head><body>
    <div class="cert">
      <h1>Certificate of Wishes</h1>
      <p>‡§Ø‡§π ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à ‡§ï‡§ø</p>
      <h2 style="margin:6px 0;color:#0b5fa8">${student.name||'‚Äî'}</h2>
      <p>‡§ï‡§ï‡•ç‡§∑‡§æ ${student.class||'‚Äî'} ¬∑ ‡§è‡§°‡§Æ‡§ø‡§∂‡§® ‡§®‡§Ç. ${student.adm||'‚Äî'}</p>
      <p class="small">‡§π‡§Æ ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§™‡§∞‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•Ä ‡§ì‡§∞ ‡§∏‡•á ‡§Ü‡§™‡§ï‡•ã ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Å ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç‡•§</p>
      <div style="margin-top:28px;font-weight:800;color:#6b2140">S.B. PUBLIC SCHOOL</div>
    </div>
    <script>setTimeout(()=>{ window.print(); setTimeout(()=>window.close(),500); },300);</script>
  </body></html>
  `;
  win.document.write(html);
  win.document.close();
}

// Print upcoming list (simple printable window)
document.getElementById('printUpcoming').addEventListener('click', function(){
  const html = '<html><head><title>Upcoming Birthdays</title><style>body{font-family:Arial;padding:20px}h1{color:#0b5fa8}li{margin-bottom:8px}</style></head><body><h1>Upcoming Birthdays (7 days)</h1>' + document.getElementById('upcomingList').innerHTML + '</body></html>';
  const w = window.open('', '_blank', 'width=700,height=800');
  w.document.write(html);
  w.document.close();
  setTimeout(()=>{ w.print(); }, 300);
});

// Helper: create clickable name element
function makeNameLink(student){
  const a = document.createElement('span');
  a.className = 'name-link';
  a.innerText = student.name || (student.adm || '‚Äî');
  a.onclick = ()=> openBirthdayModal(student);
  return a;
}

// Expose functions to main script by assigning to window (will be used later)
window._birthdayFeatures = {
  renderUpcoming: function(listHtml){ 
    document.getElementById('upcomingList').innerHTML = listHtml; 
    document.getElementById('bdayFeaturesArea').style.display = 'flex';
  },
  renderClassGrid: function(html){ 
    document.getElementById('classGrid').innerHTML = html; 
    document.getElementById('bdayFeaturesArea').style.display = 'flex';
  }
};
</script>
<!-- END: Additional Birthday Features -->
</div>

<script>
(function(){
  const SHEET_ID = "1K9EU36olQPdENJ_8wY-9AslkarnOWdrgx7F1DErnSO0";
  const SHEET_NAME = "Student's Details";
  const outContainer = document.getElementById('birthdayListContainer');
  const bannerContainer = document.getElementById('birthdayBannerContainer');
  const confettiArea = document.getElementById('confettiArea');
  const balloonArea = document.getElementById('balloonArea');

  function parseDobToDM(dob){
    if(!dob) return null;
    dob = String(dob).trim();
    let d,m;
    if(/\d{4}-\d{2}-\d{2}/.test(dob)){ const parts = dob.split('-'); d = parseInt(parts[2]); m = parseInt(parts[1]); }
    else if(/\d{2}[\/\-]\d{2}[\/\-]\d{4}/.test(dob)){ const parts = dob.includes('/') ? dob.split('/') : dob.split('-'); d = parseInt(parts[0]); m = parseInt(parts[1]); }
    else { const dt = new Date(dob); if(!isNaN(dt)) { d = dt.getDate(); m = dt.getMonth()+1; } else return null; }
    if(!d || !m) return null; return { day: d, month: m };
  }

  function todayDM(){ const now = new Date(); return { day: now.getDate(), month: now.getMonth()+1 }; }

  function triggerConfetti(count=28){
    confettiArea.innerHTML = '';
    const colors = ['#FF6B6B','#FFD93D','#6BCB77','#4D96FF','#B388EB','#FF8FB1'];
    for(let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className = 'piece';
      el.style.background = colors[i % colors.length];
      el.style.left = (Math.random()*100) + '%';
      const size = 6 + Math.random()*14;
      el.style.width = size + 'px';
      el.style.height = Math.round(size*1.2) + 'px';
      el.style.top = (-10 - Math.random()*20) + 'vh';
      el.style.animationDuration = (2.2 + Math.random()*1.6) + 's';
      confettiArea.appendChild(el);
      setTimeout(()=> el.remove(), 3800);
    }
  }

  function spawnBalloons(count=6){
    balloonArea.innerHTML = '';
    const colors = ['#FF8FB1','#FFD93D','#6BCB77','#4D96FF','#B388EB','#FF6B6B'];
    for(let i=0;i<count;i++){
      const b = document.createElement('div');
      b.className = 'balloon';
      b.style.background = colors[i % colors.length];
      b.style.left = (6 + Math.random()*88) + '%';
      b.style.width = (28 + Math.random()*30) + 'px';
      b.style.height = (36 + Math.random()*40) + 'px';
      b.style.animationDuration = (4 + Math.random()*4) + 's';
      b.style.animationDelay = (Math.random()*0.6) + 's';
      balloonArea.appendChild(b);
      setTimeout(()=> b.remove(), 9000);
    }
  }

  (async function(){
    try{
      const url = `https://docs.google.com/spreadsheets/d/1K9EU36olQPdENJ_8wY-9AslkarnOWdrgx7F1DErnSO0/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('Sheet fetch failed: ' + res.status);
      const text = await res.text();
      const jsonText = text.replace(/^[^{]*/,'').replace(/\);\\s*$/,'');
      const j = JSON.parse(jsonText);
      const cols = (j.table.cols || []).map(c => (c.label || c.id || '').toString().trim());
      const rows = (j.table.rows || []).map(r => r.c || []);
      const colMap = {};
      cols.forEach((h, i) => { colMap[h.toLowerCase()] = i; });
      function findColIndex(names){
        for(const n of names){ const k = Object.keys(colMap).find(x => x === n.toLowerCase()); if(k) return colMap[k]; }
        for(const n of names){ const k = Object.keys(colMap).find(x => x.includes(n.toLowerCase())); if(k) return colMap[k]; }
        return -1;
      }
      const idxAdm = findColIndex(['Admission No.','Admission No','Adm No','Admission Number','admission no']);
      const idxName = findColIndex(['Student Name','Name','student name']);
      const idxFather = findColIndex(['Father Name','Father','father name']);
      const idxMother = findColIndex(['Mother Name','Mother','mother name']);
      const idxDob = findColIndex(['Date of Birth','DOB','Birth Date','Date of Birth']);
      const idxClass = findColIndex(['Class']);
      const idxAddress = findColIndex(['Address']);
      const students = rows.map(r => {
        return {
          adm: (r[idxAdm] && r[idxAdm].v) ? r[idxAdm].v : '',
          name: (r[idxName] && r[idxName].v) ? r[idxName].v : '',
          father: (r[idxFather] && r[idxFather].v) ? r[idxFather].v : '',
          mother: (r[idxMother] && r[idxMother].v) ? r[idxMother].v : '',
          dob: (r[idxDob] && r[idxDob].v) ? r[idxDob].v : '',
          class: (r[idxClass] && r[idxClass].v) ? r[idxClass].v : '',
          address: (r[idxAddress] && r[idxAddress].v) ? r[idxAddress].v : ''
        };
      });
      const today = todayDM();
      const matches = students.filter(s => {
        const dm = parseDobToDM(s.dob);
        return dm && dm.day === today.day && dm.month === today.month;
      });
      if(matches.length === 0){
        outContainer.innerHTML = '‡§Ü‡§ú ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§';
        bannerContainer.style.display = 'none';
      } else {
        const names = matches.map(m => m.name || m.adm || '‚Äî').join(', ');
        bannerContainer.innerHTML = `<div class="bday-banner" role="status" aria-live="polite">üéÇ <div style="font-weight:900">${names} ‚Äî ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§ï‡•Ä ‡§π‡§æ‡§∞‡•ç‡§¶‡§ø‡§ï ‡§∂‡•Å‡§≠‡§ï‡§æ‡§Æ‡§®‡§æ‡§è‡§Å!</div><div style="margin-left:auto;font-size:13px;color:#475569">Today</div></div>`;
        bannerContainer.style.display = 'block';
        let html = '<ul style="margin:8px 0 0 18px;">';
        matches.forEach(m => {
          html += `<li><strong>${m.name || '‚Äî'}</strong> ‚Äî Class: ${m.class||'‚Äî'} ‚Äî Adm: ${m.adm||'‚Äî'} ‚Äî ‡§Æ‡§æ‡§§‡§æ-‡§™‡§ø‡§§‡§æ: ${m.father||''}${m.mother?(' / ' + m.mother):''}</li>`;
        });
        html += '</ul>';
        outContainer.innerHTML = html;
      // --- Additional features: Upcoming 7 days and Class-wise calendar ---
      try{
        // compute upcoming 7 days (including today)
        const upcoming = [];
        const todayDate = new Date();
        function dmToDate(dm, year){
          return new Date(year, dm.month-1, dm.day);
        }
        // build a lookup of birthdays by month-day
        const bdMap = {};
        students.forEach(s => {
          const dm = parseDobToDM(s.dob);
          if(!dm) return;
          const key = String(dm.day).padStart(2,'0') + '-' + String(dm.month).padStart(2,'0');
          if(!bdMap[key]) bdMap[key]=[];
          bdMap[key].push(s);
        });
        for(let i=0;i<7;i++){
          const d = new Date();
          d.setDate(todayDate.getDate() + i);
          const key = String(d.getDate()).padStart(2,'0') + '-' + String(d.getMonth()+1).padStart(2,'0');
          if(bdMap[key]){
            bdMap[key].forEach(s => {
              upcoming.push({date: d.toDateString(), student: s});
            });
          }
        }
        // render upcoming list HTML
        if(upcoming.length===0){
          window._birthdayFeatures.renderUpcoming('<li>‡§Ö‡§ó‡§≤‡•á 7 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§æ ‡§ú‡§®‡•ç‡§Æ‡§¶‡§ø‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§</li>');
        } else {
          let listHtml = '';
          upcoming.forEach(item=>{
            const s = item.student;
            const display = '<strong>'+ (s.name||s.adm||'‚Äî') +'</strong> ‚Äî ' + (s.class||'‚Äî') + ' ‚Äî ' + item.date;
            listHtml += '<li>' + display + ' &nbsp; <button class="print-btn" style="margin-left:8px" onclick="(function(){ generateCertificate('+ 'JSON.parse(' + JSON.stringify(JSON.stringify(s)) + '); })()">Print</button> &nbsp; <span class="name-link" style="margin-left:8px" onclick="(function(){ openBirthdayModal('+ 'JSON.parse(' + JSON.stringify(JSON.stringify(s)) + ') })()">View</span></li>';
          });
          window._birthdayFeatures.renderUpcoming(listHtml);
        }

        // class-wise calendar: group by class and render small boxes
        const classMap = {};
        students.forEach(s => {
          const cls = s.class || 'Others';
          if(!classMap[cls]) classMap[cls]=[];
          const dm = parseDobToDM(s.dob);
          const dmStr = dm ? (String(dm.day).padStart(2,'0') + '-' + String(dm.month).padStart(2,'0')) : '';
          classMap[cls].push({name: s.name, adm: s.adm, dob: dmStr});
        });
        let classHtml = '';
        Object.keys(classMap).sort().forEach(cls=>{
          let members = '';
          classMap[cls].forEach(m=>{
            members += '<div style="margin-bottom:6px"><span class="name-link" onclick="(function(){ openBirthdayModal('+ 'JSON.parse(' + JSON.stringify(JSON.stringify({name: m.name, adm: m.adm, class: cls, father:'', mother:'', address:''})) + ') })()">' + (m.name||'‚Äî') + '</span> <small style="color:#475569">('+ (m.dob||'‚Äî') +')</small></div>';
          });
          classHtml += '<div class="class-box"><strong style="display:block;margin-bottom:6px">'+cls+'</strong>' + members + '</div>';
        });
        window._birthdayFeatures.renderClassGrid(classHtml);
      }catch(e){
        console.error('Feature render error', e);
      }
      // --- end additional features ---

        triggerConfetti(36);
        spawnBalloons(Math.min(12, Math.max(6, matches.length*3)));
      }
    }catch(err){
      console.error('Birthday fetch error', err);
      outContainer.innerHTML = '‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: ' + (err.message || err);
      bannerContainer.style.display = 'none';
    }
  })();
})();
</script>
<!-- END: Birthday Auto-Wisher -->



      <div>
        <div class="card">
          <h2>Student Details Lookup</h2>
          <div class="small">Admission Number ‡§°‡§æ‡§≤‡§ï‡§∞ Search ‡§ï‡§∞‡•á‡§Ç</div>
          <div style="margin-top:8px" class="search-row">
            <input id="admission" placeholder="Enter Admission Number" style="flex:1;padding:8px;border-radius:8px;border:1px solid #dce6f7">
            <button class="btn search-btn" data-portal="true" onclick="searchStudent()">Search</button>
          </div>
          <div id="result"></div>
        </div>

        <div class="card">
          <h2>Student Records</h2>
          <div class="small">‡§ü‡•à‡§¨ ‡§¨‡§¶‡§≤ ‡§ï‡§∞ Fee ‡§Ø‡§æ Marksheet ‡§¶‡•á‡§ñ‡•á‡§Ç ‚Äî Mobile/Aadhar masked (last 4)‡•§</div>
          <div class="tabbar" role="tablist">
            <button class="tab active" id="tabFee" onclick="showTab('fee')">Fee Student Details</button>
            <button class="tab" id="tabMarks" onclick="showTab('marks')">Marksheet Details</button>
          </div>
          <div id="feeContainer" class="table-wrap" style="display:block">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
          <div id="marksContainer" class="table-wrap" style="display:none;margin-top:10px">‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2>Notifications</h2>
          <div id="notifyOuter" class="notify-wrap" aria-live="polite">
            <div id="notifs" class="notify-list"></div>
          </div>
        </div>

        
        </div>
      </div>
    </div>

    <div class="footer">¬© <span id="year"></span> S.B. PUBLIC SCHOOL ‚Äî All Rights Reserved</div>
  </div>

<script>
/* CONFIG */
const SHEET_ID = "1BtoDja9imrMyHMKt5oqSYoOzj9w2GWe13JcbRu1vWO8";
const NOTIF_SPEED = 0.45;
const HEADER_SPEED = 0.6;

/* HELPERS */
function escapeHtml(s){ if(s===null||s===undefined) return ""; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
async function loadSheetGviz(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network response not ok: ' + res.status);
  const text = await res.text();
  
// robust extraction: find first '{' and last '}' to extract the JSON object even if GViz wrapper varies
let startIdx = text.indexOf('{');
let endIdx = text.lastIndexOf('}');
if (startIdx === -1 || endIdx === -1 || endIdx < startIdx) {
  throw new Error('Unable to parse GViz response: JSON braces not found.');
}

// robust extraction: prefer setResponse(...) wrapper; otherwise find matching braces
function extractGvizJson(text){
  // remove common anti-XSSI prefix like )]}'
  text = text.replace(/^\)\]\}'\n?/, '');
  // 1) try to find setResponse( ... );
  let sr = /setResponse\s*\(/i;
  let m = sr.exec(text);
  if(m){
    let i = m.index + m[0].length;
    // find matching parenthesis starting at i
    let depth = 1;
    let start = i;
    for(let p = i; p < text.length; p++){
      let ch = text[p];
      if(ch === '(') depth++;
      else if(ch === ')'){
        depth--;
        if(depth === 0){
          let inside = text.substring(start, p);
          // inside might have leading comments; find first '{' and last '}' via brace matching
          let firstBrace = inside.indexOf('{');
          if(firstBrace === -1) throw new Error('No JSON object found inside setResponse()');
          // find matching brace in inside
          let j = firstBrace;
          let bDepth = 0;
          for(; j < inside.length; j++){
            if(inside[j] === '{') bDepth++;
            else if(inside[j] === '}'){
              bDepth--;
              if(bDepth === 0) break;
            }
          }
          if(j >= inside.length) throw new Error('Matching closing brace not found inside setResponse()');
          return inside.substring(firstBrace, j+1);
        }
      }
    }
  }
  // 2) fallback: find first '{' and match braces across the whole text
  let startIdx = text.indexOf('{');
  if(startIdx === -1) throw new Error('Unable to parse GViz response: JSON braces not found.');
  let depth = 0;
  for(let k = startIdx; k < text.length; k++){
    if(text[k] === '{') depth++;
    else if(text[k] === '}'){
      depth--;
      if(depth === 0){
        return text.substring(startIdx, k+1);
      }
    }
  }
  throw new Error('Unable to extract JSON: unmatched braces.');
}
const jsonText = extractGvizJson(text);


  return JSON.parse(jsonText);
}
function maskLast4(val){
  if(val===null||val===undefined) return "";
  const s = String(val).trim();
  const digits = s.replace(/\D/g,'');
  if(digits.length === 0) return '';
  const last4 = digits.slice(-4);
  return '****' + last4;
}
function isMobileHeader(h){ return /mobile|phone|contact|mob/i.test(h); }
function isAadharHeader(h){ return /aadhar|aadhaar|uid/i.test(h); }

/* TABLE RENDER */
function renderTableTo(containerId, gvizJson){
  const cols = (gvizJson.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
  const rows = (gvizJson.table.rows||[]).map(r=> r.c || []);
  const wrap = document.getElementById(containerId);
  if(rows.length === 0){
    wrap.innerHTML = "<div style='padding:12px;color:#666'>‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§</div>";
    return;
  }
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  cols.forEach(h=>{
    const th = document.createElement('th');
    th.innerText = h || '';
    trh.appendChild(th);
  });
  thead.appendChild(trh);
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    for(let i=0;i<cols.length;i++){
      const cell = r[i];
      let v = "";
      if(cell){
        if(cell.f !== undefined && String(cell.f).trim()!=='') v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        else if(cell.v !== undefined) v = cell.v;
      }
      const header = cols[i]||'';
      if(isMobileHeader(header)) v = maskLast4(v);
      if(isAadharHeader(header)) v = maskLast4(v);
      const td = document.createElement('td');
      td.innerText = v;
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  wrap.innerHTML = "";
  wrap.appendChild(table);
}

/* TABS */
function showTab(name){
  document.getElementById('feeContainer').style.display = name==='fee' ? 'block' : 'none';
  document.getElementById('marksContainer').style.display = name==='marks' ? 'block' : 'none';
  document.getElementById('tabFee').classList.toggle('active', name==='fee');
  document.getElementById('tabMarks').classList.toggle('active', name==='marks');
}

/* SEARCH */
async function searchStudent(){
  const adm = document.getElementById("admission").value.trim();
  if(!adm) return alert("Admission Number ‡§°‡§æ‡§≤‡•á‡§Ç");
  try{
    const data = await loadSheetGviz("Student's Details");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const records = rows.map(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]||('col'+i)] = v;
      }
      return obj;
    });

    const admKeys = ["Admission No.","Adm. No.","Admission Number","Adm No","Admission No"];
    const rec = records.find(r => admKeys.some(k=> String((r[k]||'')).trim() === adm || String((r[k]||'')).trim() === ("0"+adm)));
    const out = document.getElementById("result");
    out.style.display = 'block';
    if(!rec){
      out.innerHTML = "<div style='padding:12px;background:#fff;border-radius:8px;border:1px solid #f1f7ff'>No details found for this Admission Number.</div>";
      return;
    }

    const fields = ["Student Name","Father Name","Mother Name","Date of Birth","Class","Address"];
    let html = '<div style="padding:10px;border-radius:8px;background:#fff;border:1px solid #eef6ff">';
    fields.forEach(f=>{
      html += `<div style="margin-bottom:8px"><strong>${f}:</strong> ${escapeHtml(rec[f]||'')}</div>`;
    });
    html += '</div>';
    out.innerHTML = html;

  }catch(e){
    console.error("Search error", e);
    alert("Search ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‚Äî console ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§");
  }
}

/* NOTIFICATIONS vertical scroll */
let notifRAF = null;
let notifPos = 0;
function startNotifScroll(){
  const wrap = document.getElementById('notifs');
  if(!wrap) return;
  cancelAnimationFrame(notifRAF);
  function step(){
    notifPos -= NOTIF_SPEED;
    const half = wrap.scrollHeight/2 || 0;
    if(Math.abs(notifPos) >= half) notifPos = 0;
    wrap.style.transform = `translateY(${notifPos}px)`;
    notifRAF = requestAnimationFrame(step);
  }
  step();
}
function stopNotifScroll(){ if(notifRAF) cancelAnimationFrame(notifRAF); notifRAF = null; }

/* HEADER horizontal scroll */
let headerRAF = null;
let headerPos = 0;
function startHeaderScroll(){
  const strip = document.getElementById('schoolStrip');
  if(!strip) return;
  cancelAnimationFrame(headerRAF);
  function step(){
    headerPos -= HEADER_SPEED;
    const half = strip.scrollWidth/2 || 0;
    if(Math.abs(headerPos) >= half) headerPos = 0;
    strip.style.transform = `translateX(${headerPos}px)`;
    headerRAF = requestAnimationFrame(step);
  }
  step();
}
function stopHeaderScroll(){ if(headerRAF) cancelAnimationFrame(headerRAF); headerRAF = null; }

/* Build header strip from Notification sheet */
async function buildStripFromNotifications(){
  try{
    const data = await loadSheetGviz("Notification");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k)) || cols[1] || cols[0] || 'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k)) || cols[0] || 'Date';
    const strip = document.getElementById('schoolStrip');
    strip.innerHTML = "";
    const items = [];
    rows.forEach(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]] = v;
      }
      const t = obj[textKey] || '';
      const d = obj[dateKey] || '';
      if(t || d) items.push({date: d, text: t});
    });
    if(items.length === 0){
      const span = document.createElement('div'); span.className='school-chip'; span.innerText = 'No notifications to show.'; strip.appendChild(span); return;
    }
    function makeChip(it){
      const txt = (it.date ? (it.date + ' - ') : '') + it.text;
      const short = txt.length > 120 ? txt.slice(0,117)+'...' : txt;
      const span=document.createElement('div');
      span.className='school-chip';
      span.title = txt;
      span.innerText = short;
      return span;
    }
    items.forEach(it=> strip.appendChild(makeChip(it)));
    items.forEach(it=> strip.appendChild(makeChip(it)));
    startHeaderScroll();
    const outer = document.getElementById('schoolStripOuter');
    outer.addEventListener('mouseenter', stopHeaderScroll);
    outer.addEventListener('mouseleave', startHeaderScroll);
  }catch(e){
    console.error('Strip build error', e);
    const strip = document.getElementById('schoolStrip');
    strip.innerHTML = '<div class="school-chip">Unable to load header notifications ‚Äî check sheet name and sharing.</div>';
  }
}

/* load notifications vertical */
async function loadNotifications(){
  try{
    const data = await loadSheetGviz("Notification");
    const cols = (data.table.cols||[]).map(c=> (c.label||c.id||'').toString().trim());
    const rows = (data.table.rows||[]).map(r=> r.c || []);
    const textKey = cols.find(k=>/notif|notification|text|message|note|description/i.test(k)) || cols[1] || cols[0] || 'Notification';
    const dateKey = cols.find(k=>/date|day|time/i.test(k)) || cols[0] || 'Date';
    const wrap = document.getElementById('notifs');
    wrap.innerHTML = "";
    rows.forEach(cells=>{
      const obj = {};
      for(let i=0;i<cols.length;i++){
        const cell = cells[i];
        let v = "";
        if(cell){
          if(cell.v !== undefined) v = cell.v;
          else if(cell.f !== undefined) v = String(cell.f).replace(/<[^>]*>/g,'').trim();
        }
        obj[cols[i]] = v;
      }
      const d = obj[dateKey] || '';
      const t = obj[textKey] || '';
      const node = document.createElement('div');
      node.className = 'notify-item';
      node.innerHTML = `<div class="date">${escapeHtml(d)}</div><div class="text">${escapeHtml(t)}</div>`;
      wrap.appendChild(node);
    });
    const orig = wrap.children.length;
    for(let i=0;i<orig;i++){ wrap.appendChild(wrap.children[i].cloneNode(true)); }
    startNotifScroll();
    const outer = document.getElementById('notifyOuter');
    outer.addEventListener('mouseenter', stopNotifScroll);
    outer.addEventListener('mouseleave', startNotifScroll);
  }catch(e){
    console.error('Notification load error', e);
    document.getElementById('notifs').innerHTML = '<div style="padding:12px;color:#c33">Notification ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>';
  }
}

/* load fee and marks */
async function loadFeeAndMarks(){
  try{
    const feeJson = await loadSheetGviz("Fee Student Details");
    renderTableTo("feeContainer", feeJson);
  }catch(e){
    console.error(e);
    document.getElementById("feeContainer").innerHTML = "<div style='padding:12px;color:#c33'>Fee Student Details ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>";
  }
  try{
    const marksJson = await loadSheetGviz("Marksheet Details");
    renderTableTo("marksContainer", marksJson);
  }catch(e){
    console.error(e);
    document.getElementById("marksContainer").innerHTML = "<div style='padding:12px;color:#c33'>Marksheet Details ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§è ‚Äî sheet ‡§®‡§æ‡§Æ ‡§î‡§∞ sharing ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§</div>";
  }
}

/* INIT */
document.getElementById("year").innerText = new Date().getFullYear();
showTab('fee');
buildStripFromNotifications();
loadNotifications();
loadFeeAndMarks();
</script>

<!-- ====== Admission ticker JS (placed at end to ensure DOM exists) ====== -->
<script>
(function(){
  const NEWS = [
    'ADMISSION OPEN ‚Äì APRIL 2025 ¬∑ Nursery to Class 10 ¬∑ Limited Seats ‚Äî Apply Now',
    'Registration: Mon‚ÄìSat 8:30 AM ‚Äì 3:00 PM ¬∑ Documents: Birth Certificate, Aadhar (if any)',
    'Special Scholarship for Meritorious Students ‚Äî Contact Principal Office',
    'School Timings: 8:30 AM to 3:00 PM ¬∑ Transport Available ¬∑ Call +91 6389259200'
  ];
  const el = document.getElementById('admissionNewsText');
  if(!el) return;
  let idx = 0;

  function startMessage(i){
    const msg = NEWS[i];
    el.textContent = msg + ' \u00A0 \u00A0 \u00A0 ' + msg; // repeat for smooth scroll
    void el.offsetWidth;
    const containerWidth = el.parentElement.clientWidth || 600;
    const textWidth = Math.max(el.scrollWidth / 2, 200);
    const baseMs = 14000;
    const pxFactor = 9;
    const duration = Math.max(9000, Math.round(baseMs + (textWidth * pxFactor)));

    el.style.transition = 'none';
    el.style.transform = `translateX(${containerWidth}px)`;

    requestAnimationFrame(()=>{
      requestAnimationFrame(()=>{
        el.style.transition = `transform ${duration}ms linear`;
        el.style.transform = `translateX(-${textWidth}px)`;
      });
    });

    clearTimeout(el._nextTimeout);
    el._nextTimeout = setTimeout(()=>{
      idx = (i + 1) % NEWS.length;
      setTimeout(()=> startMessage(idx), 700);
    }, duration + 200);
  }

  // pause/resume on hover or focus
  const wrap = document.getElementById('admissionTickerWrap');
  function pauseTicker(){
    const style = window.getComputedStyle(el);
    const matrix = style.transform || style.webkitTransform || '';
    let tx = 0;
    if(matrix && matrix !== 'none'){
      try{
        const vals = matrix.match(/matrix\\(([^)]+)\\)/);
        if(vals){ const parts = vals[1].split(','); tx = parseFloat(parts[4]); }
      }catch(e){}
    }
    el.style.transition = 'none';
    el.style.transform = `translateX(${tx}px)`;
    clearTimeout(el._nextTimeout);
  }
  function resumeTicker(){ startMessage(idx); }

  wrap.addEventListener('mouseenter', pauseTicker);
  wrap.addEventListener('focusin', pauseTicker);
  wrap.addEventListener('mouseleave', resumeTicker);
  wrap.addEventListener('focusout', resumeTicker);

  // start
  startMessage(0);

  // expose API if needed
  window.AdmissionTicker = {
    setNews(array){ if(Array.isArray(array) && array.length){ NEWS.length=0; NEWS.push(...array); idx=0; startMessage(0); } },
    pause(){ pauseTicker(); },
    resume(){ resumeTicker(); }
  };
})();
</script>
</body>
</html>
